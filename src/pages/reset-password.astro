---
import BaseLayout from "../layouts/BaseLayout.astro";
import { supabase } from "../lib/supabase";

// En esta página el usuario llega con un token de acceso por URL que Supabase maneja automáticamente.
// La lógica de actualización se ha movido al cliente para manejar correctamente los tokens de recuperación en el fragmento (#) de la URL.
---

<BaseLayout title="Nueva Contraseña - FashionStore" showPopup={false}>
    <div
        class="min-h-[70vh] flex items-center justify-center p-4 bg-gray-50/50"
    >
        <div class="w-full max-w-md">
            <div
                class="bg-white rounded-[2.5rem] shadow-2xl shadow-slate-200/50 border border-slate-100 overflow-hidden transform transition-all"
            >
                <div class="p-10">
                    <div class="text-center mb-10">
                        <div
                            class="w-20 h-20 bg-brand-gold rounded-3xl flex items-center justify-center mx-auto mb-6 shadow-xl -rotate-3 relative overflow-hidden group"
                        >
                            <div
                                class="absolute inset-0 bg-gradient-to-tr from-white/20 to-transparent"
                            >
                            </div>
                            <svg
                                class="w-10 h-10 text-white relative z-10"
                                fill="none"
                                viewBox="0 0 24 24"
                                stroke="currentColor"
                            >
                                <path
                                    stroke-linecap="round"
                                    stroke-linejoin="round"
                                    stroke-width="1.5"
                                    d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z"
                                ></path>
                            </svg>
                        </div>
                        <h1
                            class="text-3xl font-serif font-bold text-gray-900 tracking-tight"
                        >
                            Nueva Contraseña
                        </h1>
                        <p class="text-slate-500 mt-2 font-medium">
                            Introduce tu nueva clave de acceso seguro.
                        </p>
                    </div>

                    <!-- Mensajes de Feedback -->
                    <div
                        id="status-container"
                        class="hidden mb-8 p-4 rounded-2xl text-sm font-bold flex items-center gap-3 animate-in zoom-in-95 duration-300"
                    >
                        <span id="status-icon" class="text-xl"></span>
                        <div class="flex-1">
                            <p id="status-text"></p>
                            <div id="success-link" class="hidden">
                                <a
                                    href="/login"
                                    class="inline-flex items-center gap-1 mt-2 text-brand-gold hover:text-amber-600 transition-colors font-bold uppercase text-[10px] tracking-widest"
                                >
                                    Ir al login ahora →
                                </a>
                            </div>
                        </div>
                    </div>

                    <form id="reset-password-form" class="space-y-6">
                        <div class="space-y-2">
                            <label
                                for="password"
                                class="text-[10px] font-black uppercase tracking-widest text-slate-400 ml-1"
                                >Nueva Contraseña</label
                            >
                            <input
                                type="password"
                                name="password"
                                id="password"
                                required
                                minlength="6"
                                class="w-full bg-slate-50 border border-slate-100 focus:bg-white focus:ring-4 focus:ring-brand-gold/10 focus:border-brand-gold rounded-2xl py-4 px-6 text-slate-700 font-bold transition-all outline-none"
                                placeholder="••••••••"
                            />
                        </div>

                        <div class="space-y-2">
                            <label
                                for="confirmPassword"
                                class="text-[10px] font-black uppercase tracking-widest text-slate-400 ml-1"
                                >Confirmar Contraseña</label
                            >
                            <input
                                type="password"
                                name="confirmPassword"
                                id="confirmPassword"
                                required
                                minlength="6"
                                class="w-full bg-slate-50 border border-slate-100 focus:bg-white focus:ring-4 focus:ring-brand-gold/10 focus:border-brand-gold rounded-2xl py-4 px-6 text-slate-700 font-bold transition-all outline-none"
                                placeholder="••••••••"
                            />
                        </div>

                        <button
                            type="submit"
                            id="submit-btn"
                            class="w-full bg-brand-black text-white rounded-2xl py-4 font-bold shadow-xl shadow-brand-black/20 hover:bg-gray-800 hover:-translate-y-1 transition-all active:scale-95 flex items-center justify-center gap-2"
                        >
                            <span>Actualizar Password</span>
                            <svg
                                class="w-5 h-5"
                                fill="none"
                                viewBox="0 0 24 24"
                                stroke="currentColor"
                            >
                                <path
                                    stroke-linecap="round"
                                    stroke-linejoin="round"
                                    stroke-width="2"
                                    d="M5 13l4 4L19 7"></path>
                            </svg>
                        </button>
                    </form>
                </div>
            </div>
        </div>
    </div>
</BaseLayout>

<script>
    import { supabase } from "../lib/supabase";

    const form = document.getElementById(
        "reset-password-form",
    ) as HTMLFormElement;
    const statusContainer = document.getElementById("status-container")!;
    const statusIcon = document.getElementById("status-icon")!;
    const statusText = document.getElementById("status-text")!;
    const successLink = document.getElementById("success-link")!;
    const submitBtn = document.getElementById(
        "submit-btn",
    ) as HTMLButtonElement;

    form?.addEventListener("submit", async (e) => {
        e.preventDefault();

        // Reset UI
        statusContainer.classList.add("hidden");
        successLink.classList.add("hidden");
        submitBtn.disabled = true;
        submitBtn.classList.add("opacity-50");

        const formData = new FormData(form);
        const password = formData.get("password") as string;
        const confirmPassword = formData.get("confirmPassword") as string;

        try {
            if (password !== confirmPassword)
                throw new Error("Las contraseñas no coinciden");
            if (password.length < 6)
                throw new Error(
                    "La contraseña debe tener al menos 6 caracteres",
                );

            const { error } = await supabase.auth.updateUser({
                password: password,
            });

            if (error) throw error;

            // Éxito
            statusContainer.classList.remove(
                "hidden",
                "bg-red-50",
                "text-red-600",
                "border-red-100",
            );
            statusContainer.classList.add(
                "bg-green-50",
                "text-green-600",
                "border",
                "border-green-100",
            );
            statusIcon.textContent = "LISTO";
            statusText.textContent =
                "Contraseña actualizada con éxito. Ya puedes iniciar sesión.";
            successLink.classList.remove("hidden");
            form.classList.add("hidden");
        } catch (err: any) {
            // Error
            statusContainer.classList.remove(
                "hidden",
                "bg-green-50",
                "text-green-600",
                "border-green-100",
            );
            statusContainer.classList.add(
                "bg-red-50",
                "text-red-600",
                "border",
                "border-red-100",
            );
            statusIcon.textContent = "AVISO";
            statusText.textContent =
                err.message || "Error al actualizar la contraseña";
            submitBtn.disabled = false;
            submitBtn.classList.remove("opacity-50");
        }
    });
</script>
