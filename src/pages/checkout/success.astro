---
import BaseLayout from "../../layouts/BaseLayout.astro";
import { createClient } from "@supabase/supabase-js";
import Stripe from "stripe";

// Cliente admin para crear pedidos (bypassa RLS)
const supabaseAdmin = createClient(
    import.meta.env.PUBLIC_SUPABASE_URL,
    import.meta.env.SUPABASE_SERVICE_ROLE_KEY,
    { auth: { autoRefreshToken: false, persistSession: false } },
);

// Cliente normal para consultas del usuario
const supabaseUrl = import.meta.env.PUBLIC_SUPABASE_URL;
const supabaseAnonKey = import.meta.env.PUBLIC_SUPABASE_ANON_KEY;
const supabase = createClient(supabaseUrl, supabaseAnonKey);

const stripe = new Stripe(import.meta.env.STRIPE_SECRET_KEY || "");
const sessionId = Astro.url.searchParams.get("session_id");
const accessToken = Astro.cookies.get("sb-access-token")?.value;
const refreshToken = Astro.cookies.get("sb-refresh-token")?.value;

let orderCreated = false;
let errorMsg = "";

if (sessionId) {
    try {
        const session = await stripe.checkout.sessions.retrieve(sessionId);

        if (session.payment_status === "paid") {
            const metadata = session.metadata;
            const items = JSON.parse(metadata?.items_json || "[]");

            if (accessToken) {
                await supabase.auth.setSession({
                    access_token: accessToken,
                    refresh_token: refreshToken || "",
                });
            }

            const { data: existingOrder } = await supabaseAdmin
                .from("orders")
                .select("id")
                .eq("stripe_session_id", sessionId)
                .maybeSingle();

            let order: any;
            let orderLines: any[] = [];

            if (!existingOrder) {
                const discountAmount = parseInt(metadata?.discount || "0");
                const shippingCost = parseInt(metadata?.shipping_cost || "0");
                const userIdValue =
                    metadata?.user_id && metadata.user_id !== ""
                        ? metadata.user_id
                        : null;
                const orderData = {
                    user_id: userIdValue,
                    total_amount: session.amount_total || 0,
                    shipping_cost: shippingCost,
                    shipping_name: metadata?.customer_name || "",
                    shipping_email: session.customer_details?.email || "",
                    shipping_address: metadata?.address || "",
                    shipping_city: metadata?.city || "",
                    shipping_zip: metadata?.zip || "",
                    status: "paid",
                    stripe_session_id: sessionId || "",
                    coupon_code:
                        metadata?.coupon_code && metadata.coupon_code !== ""
                            ? metadata.coupon_code
                            : null,
                    discount_amount: discountAmount,
                };

                const { data: newOrder, error: orderError } =
                    await supabaseAdmin
                        .from("orders")
                        .insert(orderData)
                        .select()
                        .single();

                if (orderError) {
                    console.error("Error al insertar pedido:", orderError);
                    throw new Error(`Error DB Pedido: ${orderError.message}`);
                }
                order = newOrder;

                // 2. Crear líneas
                const { data: variants } = await supabaseAdmin
                    .from("product_variants")
                    .select("id, product_id, size, product:products(name)")
                    .in(
                        "product_id",
                        items.map((i: any) => parseInt(i.id)),
                    );

                const newOrderLines = items.map((item: any) => {
                    const variant = variants?.find(
                        (v) =>
                            v.product_id === parseInt(item.id) &&
                            v.size === item.s,
                    );
                    return {
                        order_id: order.id,
                        product_id: parseInt(item.id),
                        variant_id: variant?.id,
                        quantity: item.q,
                        price: item.p,
                        product_name:
                            (variant?.product as any)?.name ||
                            `Producto ${item.id}`,
                        product_size: item.s,
                    };
                });

                const { error: linesError } = await supabaseAdmin
                    .from("order_items")
                    .insert(newOrderLines);

                if (linesError)
                    console.error("Error al insertar líneas:", linesError);
                orderLines = newOrderLines;

                // 3. Confirmar compra/stock
                const cartSessionId =
                    Astro.cookies.get("cart_session_id")?.value;
                if (cartSessionId) {
                    const { error: cartError } = await supabaseAdmin.rpc(
                        "confirm_cart_purchase",
                        {
                            p_session_id: cartSessionId,
                        },
                    );
                    if (cartError)
                        console.error("Error confirmando carrito:", cartError);
                }

                // 4. Finalizar cupón
                if (metadata?.coupon_id) {
                    const { finalizeCouponUse } =
                        await import("../../lib/coupon-system");
                    await finalizeCouponUse(
                        order.id.toString(),
                        userIdValue || "",
                        metadata.coupon_id,
                        discountAmount,
                        discountAmount,
                    ).catch(console.error);
                }

                // 5. Actualizar perfil si el usuario está logueado y no tiene dirección guardada
                if (userIdValue) {
                    await supabaseAdmin
                        .from("profiles")
                        .update({
                            shipping_address: metadata?.address || "",
                            shipping_city: metadata?.city || "",
                            shipping_zip: metadata?.zip || "",
                            nombre: metadata?.customer_name || undefined, // Solo si no tiene uno
                        })
                        .eq("id", userIdValue)
                        .is("shipping_address", null); // Solo si está vacía, para no sobrescribir manuales
                }
            } else {
                // El pedido ya existe (posiblemente creado por webhook o recarga)
                const { data: fullOrder } = await supabaseAdmin
                    .from("orders")
                    .select("*, order_items(*)")
                    .eq("id", existingOrder.id)
                    .single();

                order = fullOrder;
                orderLines = fullOrder.order_items || [];
                console.log(
                    "[CHECKOUT] Usando pedido existente para procesar emails.",
                );
            }

            // 5. Enviar emails (Siempre intentamos si estamos en la página de éxito)
            if (order && orderLines.length > 0) {
                try {
                    const { sendInvoiceEmail, sendAdminNewOrderNotification } =
                        await import("../../lib/emails");
                    const productIds = orderLines.map((l: any) => l.product_id);
                    const { data: products } = await supabase
                        .from("products")
                        .select("id, images")
                        .in("id", productIds);

                    const invoiceItems = orderLines.map((line: any) => {
                        const product = products?.find(
                            (p) => p.id === line.product_id,
                        );
                        return {
                            product_name: line.product_name,
                            size: line.product_size,
                            quantity: line.quantity,
                            price_at_time: line.price,
                            product_image: product?.images?.[0] || null,
                        };
                    });

                    console.log(
                        `[EMAILS] Enviando notificaciones para pedido #${order.id}`,
                    );
                    const resCust = await sendInvoiceEmail(order, invoiceItems);
                    const resAdm = await sendAdminNewOrderNotification(
                        order,
                        invoiceItems,
                    );
                    console.log(
                        `[EMAILS] Resultado: Cliente(${resCust.success}), Admin(${resAdm.success})`,
                    );
                } catch (emailErr) {
                    console.error("[EMAILS] Fallo crítico:", emailErr);
                }
            }
            orderCreated = true;
        }
    } catch (err: any) {
        console.error("Error procesando éxito de pago:", err);
        if (!orderCreated) errorMsg = err.message;
    }
}
---

<BaseLayout title="¡Pago Confirmado! - FashionStore">
    <div class="max-w-4xl mx-auto px-4 py-32 text-center">
        <div class="mb-8 flex justify-center">
            <div
                class="w-24 h-24 bg-green-100 text-green-600 rounded-full flex items-center justify-center"
            >
                <svg
                    class="w-12 h-12"
                    fill="none"
                    stroke="currentColor"
                    viewBox="0 0 24 24"
                >
                    <path
                        stroke-linecap="round"
                        stroke-linejoin="round"
                        stroke-width="2"
                        d="M5 13l4 4L19 7"></path>
                </svg>
            </div>
        </div>

        <h1 class="text-4xl font-serif font-bold text-gray-900 mb-4">
            ¡Gracias por tu compra!
        </h1>
        <p class="text-xl text-gray-600 mb-12">
            {
                errorMsg
                    ? "Hubo un pequeño error al registrar tu pedido, pero tu pago ha sido procesado. Por favor contacta con soporte."
                    : "Tu pedido ha sido procesado correctamente y pronto enviaremos los detalles a tu email."
            }
        </p>

        <div class="flex flex-col sm:flex-row gap-4 justify-center">
            {
                accessToken && (
                    <a
                        href="/mis-pedidos"
                        class="bg-brand-black text-white px-8 py-4 rounded-lg font-bold hover:bg-gray-800 transition-all"
                    >
                        Ver mis pedidos
                    </a>
                )
            }
            <a
                href="/"
                class="bg-gray-100 text-gray-800 px-8 py-4 rounded-lg font-bold hover:bg-gray-200 transition-all"
            >
                Continuar comprando
            </a>
        </div>
    </div>
</BaseLayout>

<script>
    localStorage.removeItem("cart");
    localStorage.removeItem("cart_session_id");
</script>
