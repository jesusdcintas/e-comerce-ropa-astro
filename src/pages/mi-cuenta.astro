---
import BaseLayout from "../layouts/BaseLayout.astro";
import { createClient } from "@supabase/supabase-js";

const accessToken = Astro.cookies.get("sb-access-token")?.value;
const refreshToken = Astro.cookies.get("sb-refresh-token")?.value;

if (!accessToken) {
  return Astro.redirect("/login");
}

// Crear cliente autenticado con el token del usuario
const supabaseAuth = createClient(
  import.meta.env.PUBLIC_SUPABASE_URL,
  import.meta.env.PUBLIC_SUPABASE_ANON_KEY,
  {
    global: {
      headers: {
        Authorization: `Bearer ${accessToken}`,
      },
    },
  },
);

// Verificar usuario
const {
  data: { user },
  error: sessionError,
} = await supabaseAuth.auth.getUser();

if (sessionError || !user) {
  return Astro.redirect("/login");
}

const { data: profile } = await supabaseAuth
  .from("profiles")
  .select("*")
  .eq("id", user.id)
  .maybeSingle();

const userName = profile?.name || user.user_metadata?.name || "";
const userEmail = user.email || "";
const newsletterSubscribed = profile?.newsletter_subscribed || false;

// Datos de facturación de la base de datos
const billingInfo = {
  razon_social: profile?.billing_razon_social || "",
  nif: profile?.billing_nif || "",
  direccion: profile?.billing_direccion || "",
  ciudad: profile?.billing_ciudad || "",
  codigo_postal: profile?.billing_codigo_postal || "",
};
---

<BaseLayout title="Mi Cuenta - FashionStore">
  <div class="max-w-4xl mx-auto px-4 py-12">
    <div class="mb-8">
      <div
        class="flex items-center gap-2 text-[10px] font-black uppercase tracking-[0.2em] text-brand-gold mb-4"
      >
        <span class="w-8 h-px bg-brand-gold"></span>
        Perfil de usuario
      </div>
      <h1
        class="text-4xl md:text-5xl font-black text-slate-800 tracking-tighter mb-3"
      >
        Mi <span class="text-brand-gold italic font-serif">Cuenta</span>
      </h1>
      <p class="text-slate-400 font-medium">
        Gestiona tu información personal y preferencias
      </p>
    </div>

    <!-- Información Personal -->
    <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-6 mb-6">
      <h2 class="text-xl font-semibold mb-4 flex items-center">
        <svg
          class="w-6 h-6 mr-2 text-brand-blue"
          fill="none"
          stroke="currentColor"
          viewBox="0 0 24 24"
        >
          <path
            stroke-linecap="round"
            stroke-linejoin="round"
            stroke-width="2"
            d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"
          ></path>
        </svg>
        Información Personal
      </h2>

      <form id="profile-form" class="space-y-4">
        <div>
          <label for="name" class="block text-sm font-medium text-gray-700 mb-1"
            >Nombre completo</label
          >
          <input
            type="text"
            id="name"
            name="name"
            value={userName}
            class="w-full px-4 py-2 border border-gray-300 rounded-md focus:ring-brand-blue focus:border-brand-blue"
            placeholder="Tu nombre completo"
          />
        </div>

        <div>
          <label
            for="email"
            class="block text-sm font-medium text-gray-700 mb-1">Email</label
          >
          <input
            type="email"
            id="email"
            name="email"
            value={userEmail}
            disabled
            class="w-full px-4 py-2 border border-gray-300 rounded-md bg-gray-50 text-gray-500 cursor-not-allowed"
          />
          <p class="text-xs text-gray-500 mt-1">
            El email no se puede modificar
          </p>
        </div>

        <div
          id="success-msg"
          class="hidden text-green-600 text-sm bg-green-50 p-3 rounded-md"
        >
        </div>
        <div
          id="error-msg"
          class="hidden text-red-600 text-sm bg-red-50 p-3 rounded-md"
        >
        </div>

        <div class="pt-4">
          <button
            type="submit"
            class="bg-brand-black text-white px-6 py-2 rounded-md hover:bg-gray-800 transition-colors font-medium"
          >
            Guardar Cambios
          </button>
        </div>
      </form>
    </div>

    <!-- Cambiar Contraseña -->
    <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-6 mb-6">
      <h2 class="text-xl font-semibold mb-4 flex items-center">
        <svg
          class="w-6 h-6 mr-2 text-brand-blue"
          fill="none"
          stroke="currentColor"
          viewBox="0 0 24 24"
        >
          <path
            stroke-linecap="round"
            stroke-linejoin="round"
            stroke-width="2"
            d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z"
          ></path>
        </svg>
        Cambiar Contraseña
      </h2>

      <form id="password-form" class="space-y-4">
        <div>
          <label
            for="current-password"
            class="block text-sm font-medium text-gray-700 mb-1"
            >Contraseña actual</label
          >
          <input
            type="password"
            id="current-password"
            name="current-password"
            required
            class="w-full px-4 py-2 border border-gray-300 rounded-md focus:ring-brand-blue focus:border-brand-blue"
            placeholder="Introduce tu contraseña actual"
          />
        </div>

        <div>
          <label
            for="new-password"
            class="block text-sm font-medium text-gray-700 mb-1"
            >Nueva contraseña</label
          >
          <input
            type="password"
            id="new-password"
            name="new-password"
            required
            minlength="6"
            class="w-full px-4 py-2 border border-gray-300 rounded-md focus:ring-brand-blue focus:border-brand-blue"
            placeholder="Mínimo 6 caracteres"
          />
        </div>

        <div>
          <label
            for="confirm-password"
            class="block text-sm font-medium text-gray-700 mb-1"
            >Confirmar contraseña</label
          >
          <input
            type="password"
            id="confirm-password"
            name="confirm-password"
            required
            minlength="6"
            class="w-full px-4 py-2 border border-gray-300 rounded-md focus:ring-brand-blue focus:border-brand-blue"
            placeholder="Repite la nueva contraseña"
          />
        </div>

        <div
          id="password-success-msg"
          class="hidden text-green-600 text-sm bg-green-50 p-3 rounded-md"
        >
        </div>
        <div
          id="password-error-msg"
          class="hidden text-red-600 text-sm bg-red-50 p-3 rounded-md"
        >
        </div>

        <div class="pt-4">
          <button
            type="submit"
            class="bg-brand-blue text-white px-6 py-2 rounded-md hover:bg-blue-700 transition-colors font-medium"
          >
            Actualizar Contraseña
          </button>
        </div>
      </form>
    </div>

    <!-- Datos de Facturación -->
    <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-6 mb-6">
      <h2 class="text-xl font-semibold mb-4 flex items-center">
        <svg
          class="w-6 h-6 mr-2 text-brand-gold"
          fill="none"
          stroke="currentColor"
          viewBox="0 0 24 24"
        >
          <path
            stroke-linecap="round"
            stroke-linejoin="round"
            stroke-width="2"
            d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"
          ></path>
        </svg>
        Información Tributaria / Facturación
      </h2>
      <p class="text-xs text-gray-500 mb-6">
        Configura tus datos para que se autorellenen al solicitar una factura.
      </p>

      <form id="billing-form" class="space-y-4">
        <div>
          <label
            for="billing_razon_social"
            class="block text-sm font-medium text-gray-700 mb-1"
            >Nombre o Razón Social</label
          >
          <input
            type="text"
            id="billing_razon_social"
            name="billing_razon_social"
            value={billingInfo.razon_social}
            class="w-full px-4 py-2 border border-gray-300 rounded-md focus:ring-brand-gold focus:border-brand-gold"
            placeholder="Nombre completo o Empresa S.L."
          />
        </div>

        <div class="grid grid-cols-2 gap-4">
          <div>
            <label
              for="billing_nif"
              class="block text-sm font-medium text-gray-700 mb-1"
              >NIF / CIF / DNI</label
            >
            <input
              type="text"
              id="billing_nif"
              name="billing_nif"
              value={billingInfo.nif}
              class="w-full px-4 py-2 border border-gray-300 rounded-md focus:ring-brand-gold focus:border-brand-gold uppercase"
              placeholder="Ej: B12345678"
            />
          </div>
          <div>
            <label
              for="billing_ciudad"
              class="block text-sm font-medium text-gray-700 mb-1">Ciudad</label
            >
            <input
              type="text"
              id="billing_ciudad"
              name="billing_ciudad"
              value={billingInfo.ciudad}
              class="w-full px-4 py-2 border border-gray-300 rounded-md focus:ring-brand-gold focus:border-brand-gold"
              placeholder="Ej: Madrid"
            />
          </div>
        </div>

        <div>
          <label
            for="billing_direccion"
            class="block text-sm font-medium text-gray-700 mb-1"
            >Dirección Fiscal</label
          >
          <input
            type="text"
            id="billing_direccion"
            name="billing_direccion"
            value={billingInfo.direccion}
            class="w-full px-4 py-2 border border-gray-300 rounded-md focus:ring-brand-gold focus:border-brand-gold"
            placeholder="Calle, número, piso..."
          />
        </div>

        <div>
          <label
            for="billing_codigo_postal"
            class="block text-sm font-medium text-gray-700 mb-1"
            >Código Postal</label
          >
          <input
            type="text"
            id="billing_codigo_postal"
            name="billing_codigo_postal"
            value={billingInfo.codigo_postal}
            class="w-full px-4 py-2 border border-gray-300 rounded-md focus:ring-brand-gold focus:border-brand-gold"
            placeholder="Ej: 28001"
          />
        </div>

        <div
          id="billing-success-msg"
          class="hidden text-green-600 text-sm bg-green-50 p-3 rounded-md"
        >
        </div>
        <div
          id="billing-error-msg"
          class="hidden text-red-600 text-sm bg-red-50 p-3 rounded-md"
        >
        </div>

        <div class="pt-2 text-right">
          <button
            type="submit"
            class="bg-brand-black text-white px-8 py-3 rounded-xl hover:bg-brand-gold transition-all font-bold text-xs uppercase tracking-widest shadow-lg"
          >
            Actualizar Datos Fiscales
          </button>
        </div>
      </form>
    </div>

    <!-- Dirección de Envío -->
    <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-6">
      <h2 class="text-xl font-semibold mb-6 flex items-center">
        <svg
          class="w-6 h-6 mr-2 text-brand-blue"
          fill="none"
          stroke="currentColor"
          viewBox="0 0 24 24"
        >
          <path
            stroke-linecap="round"
            stroke-linejoin="round"
            stroke-width="2"
            d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z"
          ></path>
          <path
            stroke-linecap="round"
            stroke-linejoin="round"
            stroke-width="2"
            d="M15 11a3 3 0 11-6 0 3 3 0 016 0z"></path>
        </svg>
        Dirección de Envío Predeterminada
      </h2>

      <form id="address-form" class="space-y-4">
        <div>
          <label
            for="address"
            class="block text-sm font-medium text-gray-700 mb-1"
            >Calle y número</label
          >
          <input
            type="text"
            id="address"
            name="address"
            value={user.user_metadata?.address || ""}
            class="w-full px-4 py-2 border border-gray-300 rounded-md focus:ring-brand-blue"
            placeholder="Ej: Calle Gran Vía, 12, 3ºB"
          />
        </div>

        <div class="grid grid-cols-2 gap-4">
          <div>
            <label
              for="city"
              class="block text-sm font-medium text-gray-700 mb-1">Ciudad</label
            >
            <input
              type="text"
              id="city"
              name="city"
              value={user.user_metadata?.city || ""}
              class="w-full px-4 py-2 border border-gray-300 rounded-md focus:ring-brand-blue"
              placeholder="Ej: Madrid"
            />
          </div>
          <div>
            <label
              for="zip"
              class="block text-sm font-medium text-gray-700 mb-1"
              >Código Postal</label
            >
            <input
              type="text"
              id="zip"
              name="zip"
              value={user.user_metadata?.zip || ""}
              class="w-full px-4 py-2 border border-gray-300 rounded-md focus:ring-brand-blue"
              placeholder="Ej: 28001"
            />
          </div>
        </div>

        <div
          id="address-success-msg"
          class="hidden text-green-600 text-sm bg-green-50 p-3 rounded-md"
        >
        </div>
        <div
          id="address-error-msg"
          class="hidden text-red-600 text-sm bg-red-50 p-3 rounded-md"
        >
        </div>

        <div class="pt-2">
          <button
            type="submit"
            class="bg-brand-black text-white px-6 py-2 rounded-md hover:bg-gray-800 transition-colors font-medium text-sm"
          >
            Actualizar Dirección
          </button>
        </div>
      </form>
    </div>

    <!-- Beneficios y Cupones -->
    <div
      class="bg-gradient-to-br from-slate-900 to-slate-800 rounded-3xl p-8 mb-6 shadow-xl relative overflow-hidden group"
    >
      <div
        class="absolute top-0 right-0 p-8 opacity-10 group-hover:opacity-20 transition-opacity"
      >
        <svg
          class="w-32 h-32 text-brand-gold"
          fill="currentColor"
          viewBox="0 0 24 24"
          ><path
            d="M15 5v2m0 4v2m0 4v2M5 5a2 2 0 00-2 2v3a2 2 0 110 4v3a2 2 0 002 2h14a2 2 0 002-2v-3a2 2 0 110-4V7a2 2 0 00-2-2H5z"
          ></path></svg
        >
      </div>
    </div>

    <!-- Preferencias de Newsletter -->
    <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-6 mb-6">
      <h2 class="text-xl font-semibold mb-4 flex items-center">
        <svg
          class="w-6 h-6 mr-2 text-brand-gold"
          fill="none"
          stroke="currentColor"
          viewBox="0 0 24 24"
        >
          <path
            stroke-linecap="round"
            stroke-linejoin="round"
            stroke-width="2"
            d="M3 8l7.89 5.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"
          ></path>
        </svg>
        Preferencias de Newsletter
      </h2>
      <p class="text-sm text-gray-500 mb-6">
        Recibe ofertas exclusivas, novedades y contenido especial directamente en tu correo.
      </p>

      <div class="flex items-center justify-between p-4 bg-slate-50 rounded-xl">
        <div>
          <p class="font-semibold text-slate-800">Suscripción a Newsletter</p>
          <p class="text-sm text-slate-500" id="newsletter-status-text">
            {newsletterSubscribed ? "Estás suscrito a nuestra newsletter" : "No estás suscrito actualmente"}
          </p>
        </div>
        <button
          id="newsletter-toggle-btn"
          data-subscribed={newsletterSubscribed.toString()}
          class={`relative inline-flex h-8 w-14 items-center rounded-full transition-colors focus:outline-none focus:ring-2 focus:ring-brand-gold focus:ring-offset-2 ${
            newsletterSubscribed ? 'bg-brand-gold' : 'bg-gray-300'
          }`}
        >
          <span
            id="newsletter-toggle-dot"
            class={`inline-block h-6 w-6 transform rounded-full bg-white shadow-lg transition-transform ${
              newsletterSubscribed ? 'translate-x-7' : 'translate-x-1'
            }`}
          ></span>
        </button>
      </div>

      <div
        id="newsletter-msg"
        class="hidden mt-4 text-sm p-3 rounded-md"
      ></div>

      <p class="text-xs text-gray-400 mt-4">
        Puedes darte de baja en cualquier momento. Tu email ({userEmail}) no se compartirá con terceros.
      </p>
    </div>

    <!-- Gestión de Sesión & Zona de Peligro -->
    <div class="mt-24 pt-12 border-t border-slate-100">
      <div class="grid grid-cols-1 md:grid-cols-3 gap-12">
        <!-- Columna 1: Info/Ayuda -->
        <div class="space-y-4">
          <h3
            class="text-xs font-black uppercase tracking-widest text-slate-800 flex items-center gap-2"
          >
            <span class="w-2 h-2 bg-brand-gold rounded-full"></span>
            Gestión de Cuenta
          </h3>
          <p class="text-sm text-slate-400 font-medium leading-relaxed">
            Desde aquí puedes finalizar tu sesión actual o, si lo deseas,
            solicitar la eliminación permanente de tus datos personales.
          </p>
        </div>

        <!-- Columna 2: Logout -->
        <div class="flex flex-col items-start justify-start">
          <button
            id="logout-btn-page"
            class="group w-full flex items-center justify-between px-6 py-5 bg-white border border-slate-200 rounded-2xl hover:border-slate-800 hover:bg-slate-50 transition-all duration-300"
          >
            <div class="flex items-center gap-4">
              <div
                class="w-10 h-10 rounded-xl bg-slate-50 text-slate-400 flex items-center justify-center group-hover:bg-slate-900 group-hover:text-white transition-colors"
              >
                <svg
                  class="w-5 h-5"
                  fill="none"
                  stroke="currentColor"
                  viewBox="0 0 24 24"
                >
                  <path
                    stroke-linecap="round"
                    stroke-linejoin="round"
                    stroke-width="2"
                    d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1"
                  ></path>
                </svg>
              </div>
              <div class="text-left">
                <span
                  class="block text-[11px] font-black uppercase tracking-widest text-slate-900"
                  >Cerrar Sesión</span
                >
              </div>
            </div>
            <svg
              class="w-4 h-4 text-slate-300 transform group-hover:translate-x-1 transition-transform"
              fill="none"
              stroke="currentColor"
              viewBox="0 0 24 24"
            >
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="2"
                d="M9 5l7 7-7 7"></path>
            </svg>
          </button>
        </div>

        <!-- Columna 3: Delete Account (Zona de Peligro) -->
        <div class="flex flex-col items-start justify-start">
          <button
            id="delete-account-btn"
            class="group w-full flex items-center justify-between px-6 py-5 bg-white border border-red-100 rounded-2xl hover:border-red-500 hover:bg-red-50 transition-all duration-300"
          >
            <div class="flex items-center gap-4">
              <div
                class="w-10 h-10 rounded-xl bg-red-50 text-red-500 flex items-center justify-center group-hover:bg-red-500 group-hover:text-white transition-colors"
              >
                <svg
                  class="w-5 h-5"
                  fill="none"
                  stroke="currentColor"
                  viewBox="0 0 24 24"
                >
                  <path
                    stroke-linecap="round"
                    stroke-linejoin="round"
                    stroke-width="2"
                    d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"
                  ></path>
                </svg>
              </div>
              <div class="text-left">
                <span
                  class="block text-[11px] font-black uppercase tracking-widest text-red-500"
                  >Eliminar Cuenta</span
                >
              </div>
            </div>
            <svg
              class="w-4 h-4 text-red-200 transform group-hover:translate-x-1 transition-transform"
              fill="none"
              stroke="currentColor"
              viewBox="0 0 24 24"
            >
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="2"
                d="M9 5l7 7-7 7"></path>
            </svg>
          </button>
          <p
            class="mt-4 text-[9px] text-slate-400 font-medium uppercase tracking-tighter leading-relaxed"
          >
            * Se eliminarán tus pedidos y beneficios. Si vuelves a registrarte
            con el mismo email, empezarás de cero.
          </p>
        </div>
      </div>
    </div>
  </div>
</BaseLayout>

<script>
  import { supabase } from "../lib/supabase";
  import { clearCart } from "../stores/cartStore";
  import { clearFavorites } from "../stores/favoriteStore";
  import { addToast } from "../stores/toastStore";

  // Actualizar perfil
  const profileForm = document.getElementById(
    "profile-form",
  ) as HTMLFormElement;
  const successMsg = document.getElementById("success-msg")!;
  const errorMsg = document.getElementById("error-msg")!;

  profileForm?.addEventListener("submit", async (e) => {
    e.preventDefault();
    successMsg.classList.add("hidden");
    errorMsg.classList.add("hidden");

    const formData = new FormData(profileForm);
    const name = formData.get("name") as string;

    const { error } = await supabase.auth.updateUser({
      data: { name },
    });

    if (error) {
      errorMsg.textContent = "Error al actualizar el perfil";
      errorMsg.classList.remove("hidden");
    } else {
      successMsg.textContent = "Perfil actualizado correctamente";
      successMsg.classList.remove("hidden");
    }
  });

  // Guardar dirección
  const addressForm = document.getElementById(
    "address-form",
  ) as HTMLFormElement;
  const addressSuccessMsg = document.getElementById("address-success-msg")!;
  const addressErrorMsg = document.getElementById("address-error-msg")!;

  addressForm?.addEventListener("submit", async (e) => {
    e.preventDefault();
    addressSuccessMsg.classList.add("hidden");
    addressErrorMsg.classList.add("hidden");

    const formData = new FormData(addressForm);
    const address = formData.get("address") as string;
    const city = formData.get("city") as string;
    const zip = formData.get("zip") as string;

    const { error } = await supabase.auth.updateUser({
      data: { address, city, zip },
    });

    if (error) {
      addressErrorMsg.textContent = "Error al actualizar la dirección";
      addressErrorMsg.classList.remove("hidden");
    } else {
      addressSuccessMsg.textContent =
        "Dirección guardada para tus futuros pedidos";
      addressSuccessMsg.classList.remove("hidden");
    }
  });

  // Guardar datos de facturación
  const billingForm = document.getElementById(
    "billing-form",
  ) as HTMLFormElement;
  const billingSuccessMsg = document.getElementById("billing-success-msg")!;
  const billingErrorMsg = document.getElementById("billing-error-msg")!;

  billingForm?.addEventListener("submit", async (e) => {
    e.preventDefault();
    billingSuccessMsg.classList.add("hidden");
    billingErrorMsg.classList.add("hidden");

    const formData = new FormData(billingForm);
    const data = {
      billing_razon_social: formData.get("billing_razon_social"),
      billing_nif: formData.get("billing_nif"),
      billing_direccion: formData.get("billing_direccion"),
      billing_ciudad: formData.get("billing_ciudad"),
      billing_codigo_postal: formData.get("billing_codigo_postal"),
    };

    const {
      data: { user },
    } = await supabase.auth.getUser();
    if (!user) return;

    const { error } = await supabase
      .from("profiles")
      .update(data)
      .eq("id", user.id);

    if (error) {
      billingErrorMsg.textContent = "Error al actualizar los datos fiscales";
      billingErrorMsg.classList.remove("hidden");
    } else {
      billingSuccessMsg.textContent = "Datos de facturación actualizados";
      billingSuccessMsg.classList.remove("hidden");
    }
  });

  // Cambiar contraseña
  const passwordForm = document.getElementById(
    "password-form",
  ) as HTMLFormElement;
  const passwordSuccessMsg = document.getElementById("password-success-msg")!;
  const passwordErrorMsg = document.getElementById("password-error-msg")!;

  passwordForm?.addEventListener("submit", async (e) => {
    e.preventDefault();
    passwordSuccessMsg.classList.add("hidden");
    passwordErrorMsg.classList.add("hidden");

    const formData = new FormData(passwordForm);
    const currentPassword = formData.get("current-password") as string;
    const newPassword = formData.get("new-password") as string;
    const confirmPassword = formData.get("confirm-password") as string;

    if (newPassword !== confirmPassword) {
      passwordErrorMsg.textContent = "Las contraseñas no coinciden";
      passwordErrorMsg.classList.remove("hidden");
      return;
    }

    if (newPassword.length < 6) {
      passwordErrorMsg.textContent =
        "La nueva contraseña debe tener al menos 6 caracteres";
      passwordErrorMsg.classList.remove("hidden");
      return;
    }

    // 1. Verificar contraseña actual intentando hacer login
    const { data: userData } = await supabase.auth.getUser();
    if (!userData.user?.email) return;

    const { error: loginError } = await supabase.auth.signInWithPassword({
      email: userData.user.email,
      password: currentPassword,
    });

    if (loginError) {
      passwordErrorMsg.textContent = "La contraseña actual no es correcta";
      passwordErrorMsg.classList.remove("hidden");
      return;
    }

    // 2. Si el login fue exitoso, actualizar a la nueva contraseña
    const { error } = await supabase.auth.updateUser({
      password: newPassword,
    });

    if (error) {
      passwordErrorMsg.textContent =
        "Error al cambiar la contraseña: " + error.message;
      passwordErrorMsg.classList.remove("hidden");
    } else {
      passwordSuccessMsg.textContent = "Contraseña actualizada correctamente";
      passwordSuccessMsg.classList.remove("hidden");
      passwordForm.reset();
    }
  });

  // Responder a consulta (Cliente)
  // @ts-ignore
  window.replyToInquiry = async (id: number) => {
    // @ts-ignore
    window.showCustomModal({
      title: "Responder Consulta",
      message: "¿Qué quieres decirle al equipo de soporte?",
      type: "prompt",
      onConfirm: async (response: string | undefined) => {
        if (!response) return;

        try {
          const { error: msgError } = await supabase
            .from("inquiry_messages")
            .insert({
              inquiry_id: id,
              sender_role: "customer",
              message: response,
            });

          if (msgError) throw msgError;

          // Volver a poner en pendiente para que el admin lo vea
          await supabase
            .from("product_inquiries")
            .update({ status: "pending" })
            .eq("id", id);

          location.reload();
        } catch (error: any) {
          // @ts-ignore
          window.showCustomModal({
            title: "Error de Envío",
            message: "Error al enviar el mensaje: " + error.message,
            type: "alert",
          });
        }
      },
    });
  };

  // Cerrar Sesión
  const logoutBtn = document.getElementById("logout-btn-page");
  logoutBtn?.addEventListener("click", async () => {
    await supabase.auth.signOut();
    clearCart();
    clearFavorites();
    document.cookie = "sb-access-token=; Path=/; Max-Age=0; SameSite=Lax";
    document.cookie = "sb-refresh-token=; Path=/; Max-Age=0; SameSite=Lax";
    window.location.href = "/";
  });

  // Eliminar Cuenta
  const deleteBtn = document.getElementById("delete-account-btn");
  deleteBtn?.addEventListener("click", async () => {
    // @ts-ignore
    window.showCustomModal({
      title: "Confirmar Identidad",
      message:
        "Por seguridad, introduce tu contraseña para confirmar que deseas eliminar permanentemente tu cuenta y todos sus datos asociados.",
      type: "prompt",
      inputType: "password",
      confirmText: "Borrar Cuenta",
      onConfirm: async (password: string | undefined) => {
        if (!password) return;

        try {
          const res = await fetch("/api/auth/delete-account", {
            method: "DELETE",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ password }),
          });
          const data = await res.json();

          if (data.success) {
            addToast(
              "Cuenta eliminada correctamente. Te echaremos de menos.",
              "info",
            );
            // Limpiar todo y redirigir
            await supabase.auth.signOut();
            clearCart();
            clearFavorites();
            document.cookie =
              "sb-access-token=; Path=/; Max-Age=0; SameSite=Lax";
            document.cookie =
              "sb-refresh-token=; Path=/; Max-Age=0; SameSite=Lax";
            setTimeout(() => (window.location.href = "/"), 2000);
          } else {
            // Mostrar error grande en modal (Pedidos activos, contraseña incorrecta, etc)
            // @ts-ignore
            window.showCustomModal({
              title: "Acción Denegada",
              message:
                data.error ||
                "No se ha podido procesar la baja en este momento.",
              type: "alert",
            });
          }
        } catch (error: any) {
          // @ts-ignore
          window.showCustomModal({
            title: "Error técnico",
            message:
              "Ha ocurrido un problema al conectar con el servidor. Por favor, inténtalo más tarde.",
            type: "alert",
          });
        }
      },
    });
  });

  // Newsletter Toggle
  const newsletterBtn = document.getElementById("newsletter-toggle-btn");
  const newsletterDot = document.getElementById("newsletter-toggle-dot");
  const newsletterStatusText = document.getElementById("newsletter-status-text");
  const newsletterMsg = document.getElementById("newsletter-msg");

  newsletterBtn?.addEventListener("click", async () => {
    newsletterBtn.setAttribute("disabled", "true");
    
    try {
      const res = await fetch("/api/newsletter/toggle", {
        method: "POST",
        headers: { "Content-Type": "application/json" }
      });
      const data = await res.json();

      if (data.success) {
        const isSubscribed = data.subscribed;
        
        // Actualizar visual del toggle
        if (isSubscribed) {
          newsletterBtn.classList.remove("bg-gray-300");
          newsletterBtn.classList.add("bg-brand-gold");
          newsletterDot?.classList.remove("translate-x-1");
          newsletterDot?.classList.add("translate-x-7");
          if (newsletterStatusText) newsletterStatusText.textContent = "Estás suscrito a nuestra newsletter";
        } else {
          newsletterBtn.classList.remove("bg-brand-gold");
          newsletterBtn.classList.add("bg-gray-300");
          newsletterDot?.classList.remove("translate-x-7");
          newsletterDot?.classList.add("translate-x-1");
          if (newsletterStatusText) newsletterStatusText.textContent = "No estás suscrito actualmente";
        }
        
        newsletterBtn.setAttribute("data-subscribed", isSubscribed.toString());
        
        // Mostrar mensaje de éxito
        if (newsletterMsg) {
          newsletterMsg.textContent = data.message;
          newsletterMsg.className = `mt-4 text-sm p-3 rounded-md ${isSubscribed ? 'bg-green-50 text-green-700' : 'bg-blue-50 text-blue-700'}`;
          newsletterMsg.classList.remove("hidden");
          setTimeout(() => newsletterMsg.classList.add("hidden"), 4000);
        }
        
        addToast(data.message, "success");
      } else {
        addToast(data.error || "Error al actualizar preferencia", "error");
      }
    } catch (error: any) {
      addToast("Error de conexión", "error");
    } finally {
      newsletterBtn.removeAttribute("disabled");
    }
  });
</script>
