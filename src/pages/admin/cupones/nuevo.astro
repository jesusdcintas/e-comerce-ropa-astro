---
import AdminLayout from "../../../layouts/AdminLayout.astro";
import { supabase } from "../../../lib/supabase";

const accessToken = Astro.cookies.get("sb-access-token")?.value;
if (!accessToken) return Astro.redirect("/login");

const {
    data: { user },
} = await supabase.auth.getUser(accessToken);
if (!user || user.app_metadata?.role !== "admin") return Astro.redirect("/");

// Obtener usuarios y reglas para la configuración manual
const { data: users } = await supabase
    .from("profiles")
    .select("id, nombre, email")
    .order("nombre", { ascending: true });

const { data: reglas } = await supabase
    .from("reglas_cupones")
    .select("id, nombre, descuento_porcentaje, dias_validez")
    .eq("activa", true);
---

<AdminLayout title="Crear Cupón o Regla">
    <div class="max-w-4xl mx-auto space-y-12">
        <header class="flex justify-between items-center">
            <a
                href="/admin/cupones"
                class="text-slate-400 hover:text-slate-800 flex items-center gap-2 font-bold text-sm transition-colors"
            >
                <svg
                    class="w-4 h-4"
                    fill="none"
                    stroke="currentColor"
                    viewBox="0 0 24 24"
                >
                    <path
                        stroke-linecap="round"
                        stroke-linejoin="round"
                        stroke-width="2"
                        d="M10 19l-7-7m0 0l7-7m-7 7h18"></path>
                </svg>
                Volver al Dashboard
            </a>
            <h1 class="text-2xl font-black text-slate-800 tracking-tighter">
                Configurar Nuevo <span class="text-brand-gold italic"
                    >Descuento</span
                >
            </h1>
        </header>

        <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
            <!-- Formulario Cupón Manual -->
            <div
                class="bg-white p-8 rounded-2xl border border-slate-100 shadow-xl relative overflow-hidden group"
            >
                <div
                    class="absolute top-0 right-0 p-4 opacity-5 group-hover:opacity-10 transition-opacity"
                >
                    <svg
                        class="w-24 h-24"
                        fill="currentColor"
                        viewBox="0 0 24 24"
                        ><path
                            d="M15 5v2m0 4v2m0 4v2M5 5a2 2 0 00-2 2v3a2 2 0 110 4v3a2 2 0 002 2h14a2 2 0 002-2v-3a2 2 0 110-4V7a2 2 0 00-2-2H5z"
                        ></path></svg
                    >
                </div>

                <h2 class="text-xl font-black text-slate-800 mb-6">
                    Cupón Manual
                </h2>
                <p class="text-xs text-slate-500 mb-8">
                    Crea un código específico para campañas de marketing o
                    atención al cliente.
                </p>

                <form
                    id="manual-coupon-form"
                    class="space-y-4 text-sm font-medium"
                >
                    <div>
                        <label
                            class="block text-slate-400 text-[10px] font-bold uppercase tracking-widest mb-2"
                            >Código del Cupón</label
                        >
                        <input
                            name="codigo"
                            type="text"
                            placeholder="EJ: BIENVENIDA10"
                            required
                            class="w-full px-4 py-3 bg-slate-50 border border-slate-100 rounded-xl focus:ring-2 focus:ring-brand-gold/20 outline-none uppercase font-mono font-bold"
                        />
                    </div>

                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label
                                class="block text-slate-400 text-[10px] font-bold uppercase tracking-widest mb-2"
                                >Descuento Regalo (%)</label
                            >
                            <input
                                name="descuento"
                                id="manual-discount-input"
                                type="number"
                                min="1"
                                max="100"
                                placeholder="15"
                                required
                                class="w-full px-4 py-3 bg-slate-50 border border-slate-100 rounded-xl focus:ring-2 focus:ring-brand-gold/20 outline-none"
                            />
                        </div>
                        <div>
                            <label
                                class="block text-slate-400 text-[10px] font-bold uppercase tracking-widest mb-2"
                                >Días validez</label
                            >
                            <input
                                name="validez"
                                id="manual-validity-input"
                                type="number"
                                placeholder="30"
                                required
                                class="w-full px-4 py-3 bg-slate-50 border border-slate-100 rounded-xl focus:ring-2 focus:ring-brand-gold/20 outline-none"
                            />
                        </div>
                    </div>

                    <div class="pt-4 border-t border-slate-50">
                        <label
                            class="block text-slate-400 text-[10px] font-bold uppercase tracking-widest mb-4"
                            >Objetivo del Cupón (Target)</label
                        >

                        <div class="grid grid-cols-3 gap-2 mb-6">
                            <label class="cursor-pointer">
                                <input
                                    type="radio"
                                    name="target_mode"
                                    value="public"
                                    class="hidden peer"
                                    checked
                                />
                                <div
                                    class="p-3 text-center border border-slate-100 rounded-xl peer-checked:border-brand-gold peer-checked:bg-brand-gold/5 peer-checked:text-brand-gold transition-all hover:bg-slate-50"
                                >
                                    <p class="text-[10px] font-bold uppercase">
                                        Público
                                    </p>
                                    <p class="text-[8px] opacity-60">
                                        Cualquiera
                                    </p>
                                </div>
                            </label>
                            <label class="cursor-pointer">
                                <input
                                    type="radio"
                                    name="target_mode"
                                    value="specific"
                                    class="hidden peer"
                                />
                                <div
                                    class="p-3 text-center border border-slate-100 rounded-xl peer-checked:border-brand-gold peer-checked:bg-brand-gold/5 peer-checked:text-brand-gold transition-all hover:bg-slate-50"
                                >
                                    <p class="text-[10px] font-bold uppercase">
                                        Clientes
                                    </p>
                                    <p class="text-[8px] opacity-60">
                                        Selección
                                    </p>
                                </div>
                            </label>
                            <label class="cursor-pointer">
                                <input
                                    type="radio"
                                    name="target_mode"
                                    value="segment"
                                    class="hidden peer"
                                />
                                <div
                                    class="p-3 text-center border border-slate-100 rounded-xl peer-checked:border-brand-gold peer-checked:bg-brand-gold/5 peer-checked:text-brand-gold transition-all hover:bg-slate-50"
                                >
                                    <p class="text-[10px] font-bold uppercase">
                                        Segmento
                                    </p>
                                    <p class="text-[8px] opacity-60">
                                        Por Regla
                                    </p>
                                </div>
                            </label>
                        </div>

                        <!-- Secciones dinámicas -->
                        <div
                            id="target-section-public"
                            class="text-[10px] text-slate-400 p-4 bg-slate-50 rounded-xl mb-4 text-center border border-dashed border-slate-200"
                        >
                            Este código podrá ser canjeado por cualquier cliente
                            registrado (una vez por persona).
                        </div>

                        <div
                            id="target-section-specific"
                            class="hidden space-y-4 mb-6"
                        >
                            <div class="flex items-center justify-between mb-2">
                                <label
                                    class="block text-slate-800 text-[10px] font-black uppercase tracking-widest"
                                    >Asignar a clientes específicos</label
                                >
                                <span
                                    id="selected-count"
                                    class="text-[9px] font-bold text-brand-gold bg-brand-gold/10 px-2 py-0.5 rounded-full hidden"
                                >
                                    0 Seleccionados
                                </span>
                            </div>

                            <!-- Buscador de Clientes -->
                            <div class="relative group">
                                <input
                                    type="text"
                                    id="client-search"
                                    placeholder="Buscar por nombre o email..."
                                    class="w-full pl-10 pr-4 py-2.5 bg-slate-50 border border-slate-100 rounded-xl text-xs focus:ring-2 focus:ring-brand-gold/20 focus:bg-white outline-none transition-all"
                                />
                                <svg
                                    class="absolute left-3 top-1/2 -translate-y-1/2 w-4 h-4 text-slate-300 group-focus-within:text-brand-gold transition-colors"
                                    fill="none"
                                    viewBox="0 0 24 24"
                                    stroke="currentColor"
                                >
                                    <path
                                        stroke-linecap="round"
                                        stroke-linejoin="round"
                                        stroke-width="2"
                                        d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"
                                    ></path>
                                </svg>
                            </div>

                            <!-- Lista de Clientes Premium -->
                            <div
                                id="clients-list"
                                class="border border-slate-100 rounded-2xl divide-y divide-slate-50 max-h-64 overflow-y-auto custom-scrollbar bg-white shadow-inner"
                            >
                                {
                                    users?.map((u) => (
                                        <div
                                            class="client-item group flex items-center gap-3 p-3 cursor-pointer hover:bg-slate-50 transition-all relative"
                                            data-id={u.id}
                                            data-search={`${u.nombre} ${u.email}`.toLowerCase()}
                                        >
                                            <div class="w-8 h-8 rounded-lg bg-slate-100 flex items-center justify-center text-[10px] font-black text-slate-500 uppercase group-hover:bg-brand-gold group-hover:text-white transition-colors">
                                                {u.nombre?.charAt(0) ||
                                                    u.email?.charAt(0)}
                                            </div>
                                            <div class="flex-1 min-w-0">
                                                <p class="text-[11px] font-bold text-slate-800 truncate mb-0.5">
                                                    {u.nombre || "Sin Nombre"}
                                                </p>
                                                <p class="text-[9px] text-slate-400 truncate font-medium">
                                                    {u.email}
                                                </p>
                                            </div>
                                            <div class="selection-indicator hidden">
                                                <svg
                                                    class="w-5 h-5 text-brand-gold"
                                                    fill="currentColor"
                                                    viewBox="0 0 20 20"
                                                >
                                                    <path
                                                        fill-rule="evenodd"
                                                        d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z"
                                                        clip-rule="evenodd"
                                                    />
                                                </svg>
                                            </div>
                                        </div>
                                    ))
                                }
                            </div>

                            <!-- Select oculto para back compatibility con el script actual -->
                            <select name="cliente_ids" multiple class="hidden">
                                {
                                    users?.map((u) => (
                                        <option value={u.id}>{u.email}</option>
                                    ))
                                }
                            </select>

                            <p
                                class="text-[9px] text-slate-400 italic text-center"
                            >
                                Haz clic en los clientes para añadirlos a la
                                lista de emisión.
                            </p>
                        </div>

                        <div
                            id="target-section-segment"
                            class="hidden space-y-3 mb-4"
                        >
                            <label
                                class="block text-slate-800 text-[10px] font-black uppercase tracking-widest"
                                >Segmento por Regla</label
                            >
                            <select
                                name="regla_id"
                                id="manual-rule-select"
                                class="w-full px-4 py-3 bg-white border border-slate-100 rounded-xl focus:ring-2 focus:ring-brand-gold/20 outline-none"
                            >
                                <option value="">-- Seleccionar Regla --</option
                                >
                                {
                                    reglas?.map((r) => (
                                        <option
                                            value={r.id}
                                            data-discount={
                                                r.descuento_porcentaje
                                            }
                                            data-validity={r.dias_validez}
                                        >
                                            {r.nombre} ({r.descuento_porcentaje}
                                            %)
                                        </option>
                                    ))
                                }
                            </select>
                            <p class="text-[9px] text-slate-400">
                                El cupón solo será válido si el cliente cumple
                                las condiciones de esta regla.
                            </p>
                        </div>
                    </div>

                    <button
                        type="submit"
                        class="w-full bg-brand-gold text-white py-4 rounded-xl font-bold hover:bg-yellow-600 transition-all shadow-lg shadow-brand-gold/20 mt-4"
                    >
                        Generar Cupón Dirigido
                    </button>
                </form>
            </div>

            <!-- Formulario Regla Automática -->
            <div
                class="bg-slate-900 p-8 rounded-2xl border border-slate-800 shadow-xl relative overflow-hidden group"
            >
                <div
                    class="absolute top-0 right-0 p-4 opacity-10 group-hover:opacity-20 transition-opacity"
                >
                    <svg
                        class="w-24 h-24 text-brand-gold"
                        fill="currentColor"
                        viewBox="0 0 24 24"
                        ><path d="M13 10V3L4 14h7v7l9-11h-7z"></path></svg
                    >
                </div>

                <h2 class="text-xl font-black text-white mb-6">
                    Regla de Fidelización
                </h2>
                <p class="text-xs text-slate-400 mb-8">
                    Define criterios para que el sistema regale cupones de forma
                    automática.
                </p>

                <form id="rule-form" class="space-y-4 text-sm font-medium">
                    <div>
                        <label
                            class="block text-slate-500 text-[10px] font-bold uppercase tracking-widest mb-2"
                            >Nombre de la Regla</label
                        >
                        <input
                            name="nombre"
                            type="text"
                            placeholder="Ej: Fan de la Marca"
                            required
                            class="w-full px-4 py-3 bg-slate-800 border border-slate-700 rounded-xl text-white outline-none focus:ring-2 focus:ring-brand-gold/50"
                        />
                    </div>

                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label
                                class="block text-slate-500 text-[10px] font-bold uppercase tracking-widest mb-2"
                                >Condición</label
                            >
                            <select
                                name="tipo_regla"
                                class="w-full px-4 py-3 bg-slate-800 border border-slate-700 rounded-xl text-white outline-none"
                            >
                                <option value="numero_compras"
                                    >Nº de Compras</option
                                >
                                <option value="compra_minima"
                                    >Gasto Mínimo (Pedido)</option
                                >
                                <option value="gasto_periodo"
                                    >Gasto Acumulado (Total)</option
                                >
                                <option value="antiguedad_cuenta"
                                    >Antigüedad de Cuenta (Nuevos)</option
                                >
                            </select>
                        </div>
                        <div>
                            <label
                                class="block text-slate-500 text-[10px] font-bold uppercase tracking-widest mb-2"
                                id="label-valor-minimo">Valor Requerido</label
                            >
                            <input
                                name="valor_minimo"
                                type="number"
                                placeholder="50"
                                required
                                class="w-full px-4 py-3 bg-slate-800 border border-slate-700 rounded-xl text-white outline-none focus:ring-2 focus:ring-brand-gold/50"
                            />
                        </div>
                    </div>

                    <div id="period-container" class="hidden">
                        <label
                            class="block text-slate-500 text-[10px] font-bold uppercase tracking-widest mb-2"
                            >Periodo de Gasto (Días)</label
                        >
                        <input
                            name="periodo_dias"
                            type="number"
                            placeholder="30"
                            class="w-full px-4 py-3 bg-slate-800 border border-slate-700 rounded-xl text-white outline-none focus:ring-2 focus:ring-brand-gold/50"
                        />
                        <p class="text-[10px] text-slate-500 mt-2">
                            Analizará las compras del cliente en los últimos X
                            días.
                        </p>
                    </div>

                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label
                                class="block text-slate-500 text-[10px] font-bold uppercase tracking-widest mb-2"
                                >Regalo (% Desc)</label
                            >
                            <input
                                name="descuento"
                                type="number"
                                placeholder="15"
                                required
                                class="w-full px-4 py-3 bg-slate-800 border border-slate-700 rounded-xl text-white outline-none"
                            />
                        </div>
                        <div>
                            <label
                                class="block text-slate-500 text-[10px] font-bold uppercase tracking-widest mb-2"
                                >Validez Cupón (Días)</label
                            >
                            <input
                                name="validez"
                                type="number"
                                placeholder="90"
                                required
                                class="w-full px-4 py-3 bg-slate-800 border border-slate-700 rounded-xl text-white outline-none"
                            />
                        </div>
                    </div>

                    <button
                        type="submit"
                        class="w-full bg-white text-slate-900 py-4 rounded-xl font-bold hover:bg-slate-100 transition-all mt-4"
                    >
                        Activar Regla Automática
                    </button>
                </form>
            </div>
        </div>
    </div>

    <script>
        // Helper to set loading state
        const setLoading = (formId: string, isLoading: boolean) => {
            const form = document.getElementById(formId);
            const btn = form?.querySelector(
                'button[type="submit"]',
            ) as HTMLButtonElement | null;
            if (btn) {
                btn.disabled = isLoading;
                if (isLoading) {
                    btn.setAttribute("data-original-text", btn.innerText);
                    btn.innerText = "Procesando...";
                    btn.classList.add("opacity-50", "cursor-not-allowed");
                } else {
                    btn.innerText =
                        btn.getAttribute("data-original-text") || btn.innerText;
                    btn.classList.remove("opacity-50", "cursor-not-allowed");
                }
            }
        };

        // Logic for Manual Coupon: Targeted Mode Switching
        const targetModes = document.querySelectorAll(
            'input[name="target_mode"]',
        );
        const sections: Record<string, HTMLElement | null> = {
            public: document.getElementById("target-section-public"),
            specific: document.getElementById("target-section-specific"),
            segment: document.getElementById("target-section-segment"),
        };

        targetModes.forEach((radio) => {
            radio.addEventListener("change", (e) => {
                const selected = (e.target as HTMLInputElement).value;
                Object.entries(sections).forEach(([mode, el]) => {
                    if (el) el.classList.toggle("hidden", mode !== selected);
                });

                // Si cambiamos a 'public' o 'specific', tal vez no queremos autolimpiar,
                // pero si cambiamos a 'segment', el select de abajo mandará.
            });
        });

        // Auto-rellenado según Regla
        const manualRuleSelect = document.getElementById(
            "manual-rule-select",
        ) as HTMLSelectElement;
        const manualDiscountInput = document.getElementById(
            "manual-discount-input",
        ) as HTMLInputElement;
        const manualValidityInput = document.getElementById(
            "manual-validity-input",
        ) as HTMLInputElement;

        manualRuleSelect?.addEventListener("change", () => {
            const selectedOption = manualRuleSelect.selectedOptions[0];
            if (selectedOption && selectedOption.value) {
                const discount = selectedOption.getAttribute("data-discount");
                const validity = selectedOption.getAttribute("data-validity");

                if (discount && manualDiscountInput) {
                    manualDiscountInput.value = discount;
                }
                if (validity && manualValidityInput) {
                    manualValidityInput.value = validity;
                }
            }
        });

        // Lógica Premium de Selección de Clientes (Inicialización)
        const clientSearch = document.getElementById(
            "client-search",
        ) as HTMLInputElement;
        const clientItems = document.querySelectorAll(".client-item");
        const manualForm = document.getElementById(
            "manual-coupon-form",
        ) as HTMLFormElement;
        const hiddenSelect = manualForm?.querySelector(
            'select[name="cliente_ids"]',
        ) as HTMLSelectElement;
        const selectedCountLabel = document.getElementById("selected-count");

        // Búsqueda en tiempo real
        clientSearch?.addEventListener("input", (e) => {
            const term = (e.target as HTMLInputElement).value.toLowerCase();
            clientItems.forEach((item) => {
                const searchData = (item as HTMLElement).dataset.search || "";
                if (searchData.includes(term)) {
                    (item as HTMLElement).classList.remove("hidden");
                } else {
                    (item as HTMLElement).classList.add("hidden");
                }
            });
        });

        // Toggle de selección
        clientItems.forEach((item) => {
            item.addEventListener("click", () => {
                const id = (item as HTMLElement).dataset.id;
                const indicator = item.querySelector(".selection-indicator");
                const option = hiddenSelect.querySelector(
                    `option[value="${id}"]`,
                ) as HTMLOptionElement;

                if (option.selected) {
                    option.selected = false;
                    item.classList.remove(
                        "bg-brand-gold/5",
                        "border-l-4",
                        "border-brand-gold",
                    );
                    indicator?.classList.add("hidden");
                } else {
                    option.selected = true;
                    item.classList.add(
                        "bg-brand-gold/5",
                        "border-l-4",
                        "border-brand-gold",
                    );
                    indicator?.classList.remove("hidden");
                }

                // Actualizar contador
                const selectedCount = Array.from(
                    hiddenSelect.selectedOptions,
                ).length;
                if (selectedCountLabel) {
                    selectedCountLabel.textContent = `${selectedCount} Seleccionados`;
                    selectedCountLabel.classList.toggle(
                        "hidden",
                        selectedCount === 0,
                    );
                }
            });
        });

        manualForm?.addEventListener("submit", async (e) => {
            e.preventDefault();
            setLoading("manual-coupon-form", true);

            const formData = new FormData(manualForm);
            const mode = formData.get("target_mode");

            // Collect target data according to mode
            let cliente_ids: string[] = [];
            let regla_id: string | null = null;

            if (mode === "specific") {
                const select = manualForm.querySelector(
                    'select[name="cliente_ids"]',
                ) as HTMLSelectElement;
                cliente_ids = Array.from(select.selectedOptions)
                    .map((opt) => opt.value)
                    .filter((val) => val !== "");
                if (cliente_ids.length === 0) {
                    alert("Por favor selecciona al menos un cliente.");
                    setLoading("manual-coupon-form", false);
                    return;
                }
            } else if (mode === "segment") {
                regla_id = formData.get("regla_id") as string;
                if (!regla_id) {
                    alert("Por favor selecciona una regla de segmentación.");
                    setLoading("manual-coupon-form", false);
                    return;
                }
            }

            const descuento = parseInt(formData.get("descuento") as string);
            const validez = parseInt(formData.get("validez") as string);
            const exp = new Date();
            exp.setDate(exp.getDate() + validez);

            try {
                const response = await fetch("/api/coupons/manage", {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({
                        action: "create-coupon",
                        data: {
                            codigo: (formData.get("codigo") as string)
                                .toUpperCase()
                                .trim(),
                            descuento_porcentaje: descuento,
                            fecha_expiracion: exp.toISOString(),
                            cliente_ids:
                                cliente_ids.length > 0 ? cliente_ids : null,
                            regla_id: regla_id || null,
                            generado_por: "manual",
                        },
                    }),
                });

                const result = await response.json();

                if (result.success) {
                    alert("¡Cupón creado con éxito!");
                    window.location.href = "/admin/cupones";
                } else {
                    alert(
                        "Error: " +
                            (result.error || "Ocurrió un error inesperado"),
                    );
                }
            } catch (err) {
                console.error("Fetch Error:", err);
                alert("Error de conexión con el servidor");
            } finally {
                setLoading("manual-coupon-form", false);
            }
        });

        // Logic for Automation Rules
        const ruleForm = document.getElementById(
            "rule-form",
        ) as HTMLFormElement;
        // Show/Hide period field based on rule type
        const typeSelect = ruleForm?.querySelector(
            'select[name="tipo_regla"]',
        ) as HTMLSelectElement;
        const periodContainer = document.getElementById("period-container");
        const labelValor = document.getElementById("label-valor-minimo");

        typeSelect?.addEventListener("change", () => {
            const val = typeSelect.value;
            const valueContainer = labelValor?.parentElement;

            if (val === "antiguedad_cuenta") {
                periodContainer?.classList.remove("hidden");
                valueContainer?.classList.add(
                    "opacity-20",
                    "pointer-events-none",
                );
                if (labelValor) labelValor.innerText = "No aplica";
            } else if (val === "gasto_periodo") {
                periodContainer?.classList.remove("hidden");
                valueContainer?.classList.remove(
                    "opacity-20",
                    "pointer-events-none",
                );
                if (labelValor) labelValor.innerText = "Gasto Acumulado (€)";
            } else {
                periodContainer?.classList.add("hidden");
                valueContainer?.classList.remove(
                    "opacity-20",
                    "pointer-events-none",
                );
                if (labelValor)
                    labelValor.innerText =
                        val === "compra_minima"
                            ? "Gasto Mínimo (€)"
                            : "Nº de Pedidos";
            }
        });

        ruleForm?.addEventListener("submit", async (e) => {
            e.preventDefault();
            setLoading("rule-form", true);

            const formData = new FormData(ruleForm);
            const tipo = formData.get("tipo_regla") as string;
            const valor = parseInt(formData.get("valor_minimo") as string);
            const periodo =
                parseInt(formData.get("periodo_dias") as string) || 0;

            try {
                const response = await fetch("/api/coupons/manage", {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({
                        action: "create-rule",
                        data: {
                            nombre: formData.get("nombre"),
                            tipo_regla: tipo,
                            monto_minimo:
                                tipo === "compra_minima" ||
                                tipo === "gasto_periodo"
                                    ? Math.max(1, valor * 100)
                                    : 1,
                            numero_minimo:
                                tipo === "numero_compras"
                                    ? Math.max(1, valor)
                                    : 0,
                            periodo_dias: periodo,
                            descuento_porcentaje: parseInt(
                                formData.get("descuento") as string,
                            ),
                            validez: parseInt(
                                formData.get("validez") as string,
                            ),
                        },
                    }),
                });

                const result = await response.json();

                if (result.success) {
                    alert("¡Regla activada con éxito!");
                    window.location.href = "/admin/cupones";
                } else {
                    alert(
                        "Error: " +
                            (result.error || "Ocurrió un error inesperado"),
                    );
                }
            } catch (err) {
                console.error("Fetch Error:", err);
                alert("Error de conexión con el servidor");
            } finally {
                setLoading("rule-form", false);
            }
        });
    </script>
</AdminLayout>
