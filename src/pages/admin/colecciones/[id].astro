---
import AdminLayout from "../../../layouts/AdminLayout.astro";
import { supabase } from "../../../lib/supabase";

const { id } = Astro.params;

if (!id) return Astro.redirect("/admin/colecciones");

// Process Add/Remove logic
if (Astro.request.method === "POST") {
    const formData = await Astro.request.formData();
    const action = formData.get("action");
    const productId = formData.get("product_id");

    if (action === "add" && productId) {
        await supabase.from("collection_products").insert({
            collection_id: id,
            product_id: parseInt(productId.toString()),
        });
    } else if (action === "remove" && productId) {
        await supabase
            .from("collection_products")
            .delete()
            .match({
                collection_id: id,
                product_id: parseInt(productId.toString()),
            });
    } else if (action === "add_all") {
        const productIdsStr = formData.get("product_ids");
        if (productIdsStr) {
            const ids = productIdsStr
                .toString()
                .split(",")
                .filter(Boolean)
                .map((i) => parseInt(i));
            if (ids.length > 0) {
                const inserts = ids.map((pid) => ({
                    collection_id: id,
                    product_id: pid,
                }));
                await supabase.from("collection_products").upsert(inserts);
            }
        }
    } else if (action === "remove_all") {
        const productIdsStr = formData.get("product_ids");
        if (productIdsStr) {
            const ids = productIdsStr
                .toString()
                .split(",")
                .filter(Boolean)
                .map((i) => parseInt(i));
            if (ids.length > 0) {
                await supabase
                    .from("collection_products")
                    .delete()
                    .eq("collection_id", id)
                    .in("product_id", ids);
            }
        }
    }
}

// Lógica de buscador
const search = Astro.url.searchParams.get("search") || "";

const { data: collection } = await supabase
    .from("collections")
    .select("*")
    .eq("id", id)
    .single();
if (!collection) return Astro.redirect("/admin/colecciones");

// Get currently assigned products
const { data: assignedItems } = await supabase
    .from("collection_products")
    .select("product_id")
    .eq("collection_id", id);
const assignedProductIds = assignedItems?.map((i) => i.product_id) || [];

// Fetch ALL products (or use search)
let productQuery = supabase
    .from("products")
    .select("id, name, images, price, stock")
    .order("created_at", { ascending: false });
if (search) {
    productQuery = productQuery.ilike("name", `%${search}%`);
}
const { data: allProducts } = await productQuery;

const productsToAdd =
    allProducts
        ?.filter((p) => !assignedProductIds.includes(p.id))
        .map((p) => p.id) || [];
const productsToRemove =
    allProducts
        ?.filter((p) => assignedProductIds.includes(p.id))
        .map((p) => p.id) || [];

function formatPrice(cents: number) {
    return `${(cents / 100).toFixed(2)}€`;
}
---

<AdminLayout title={`Editar Colección: ${collection.name}`}>
    <div
        class="max-w-7xl mx-auto px-4 py-8 animate-in fade-in slide-in-from-bottom-6 duration-700"
    >
        <!-- Cabecera -->
        <div class="mb-8">
            <a
                href="/admin/colecciones"
                class="inline-flex items-center text-xs font-bold text-slate-400 hover:text-brand-gold uppercase tracking-widest mb-6 transition-colors"
            >
                <svg
                    class="w-4 h-4 mr-2"
                    fill="none"
                    viewBox="0 0 24 24"
                    stroke="currentColor"
                    ><path
                        stroke-linecap="round"
                        stroke-linejoin="round"
                        stroke-width="2"
                        d="M10 19l-7-7m0 0l7-7m-7 7h18"></path></svg
                >
                Volver a Colecciones
            </a>

            <div
                class="flex items-center justify-between border-b border-slate-100 pb-8"
            >
                <div>
                    <span
                        class="inline-block px-3 py-1 bg-brand-gold/10 text-brand-gold rounded-full text-[10px] font-black uppercase tracking-widest border border-brand-gold/20 mb-3"
                        >ID: {collection.id.split("-")[0]}</span
                    >
                    <h2
                        class="text-4xl font-black text-slate-800 tracking-tighter"
                    >
                        Colección: <span
                            class="text-brand-gold italic font-serif"
                            >{collection.name}</span
                        >
                    </h2>
                    <p class="text-slate-400 font-medium tracking-tight mt-2">
                        {assignedProductIds.length} Productos asignados en total actualmente.
                    </p>
                </div>
            </div>
        </div>

        <!-- Buscador y Acciones Masivas -->
        <div
            class="bg-white p-6 rounded-[2.5rem] shadow-sm border border-slate-100 mb-8 flex flex-col md:flex-row gap-6 items-center"
        >
            <form class="flex-1 flex w-full md:w-auto gap-4" method="GET">
                <div class="relative flex-1">
                    <svg
                        class="absolute left-4 top-1/2 -translate-y-1/2 w-4 h-4 text-slate-400"
                        fill="none"
                        viewBox="0 0 24 24"
                        stroke="currentColor"
                    >
                        <path
                            stroke-linecap="round"
                            stroke-linejoin="round"
                            stroke-width="2"
                            d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"
                        ></path>
                    </svg>
                    <input
                        type="text"
                        name="search"
                        value={search}
                        placeholder="Busca productos por nombre o navega..."
                        class="w-full pl-11 pr-4 py-3 bg-slate-50 border-none rounded-2xl text-sm focus:ring-2 focus:ring-brand-gold/20 transition-all"
                    />
                </div>
                <button
                    type="submit"
                    class="px-6 py-3 bg-slate-900 text-white rounded-2xl hover:bg-brand-gold transition-colors font-bold text-sm"
                >
                    Buscar
                </button>
            </form>

            <div
                class="flex gap-4 w-full md:w-auto overflow-x-auto pb-2 md:pb-0"
            >
                <form id="bulk-add-form" method="POST">
                    <input type="hidden" name="action" value="add_all" />
                    <input
                        type="hidden"
                        name="product_ids"
                        id="add-product-ids"
                        value=""
                    />
                    <button
                        type="submit"
                        id="bulk-add-btn"
                        class="px-5 py-3 bg-brand-gold text-white rounded-2xl hover:bg-amber-500 transition-colors font-bold text-sm whitespace-nowrap shadow-lg disabled:opacity-50 disabled:cursor-not-allowed hidden"
                        disabled
                    >
                        + Añadir <span id="add-count">0</span> selec.
                    </button>
                </form>

                <form id="bulk-remove-form" method="POST">
                    <input type="hidden" name="action" value="remove_all" />
                    <input
                        type="hidden"
                        name="product_ids"
                        id="remove-product-ids"
                        value=""
                    />
                    <button
                        type="submit"
                        id="bulk-remove-btn"
                        class="px-5 py-3 bg-red-50 text-red-500 rounded-2xl hover:bg-red-100 transition-colors font-bold text-sm whitespace-nowrap disabled:opacity-50 disabled:cursor-not-allowed hidden"
                        disabled
                    >
                        - Quitar <span id="remove-count">0</span> selec.
                    </button>
                </form>
            </div>
        </div>

        <!-- Lista de productos -->
        <div
            class="bg-white rounded-[2.5rem] shadow-sm border border-slate-100 overflow-hidden"
        >
            <table class="w-full text-left">
                <thead class="bg-slate-50/50 border-b border-slate-100">
                    <tr>
                        <th class="px-6 py-4 w-10">
                            <input
                                type="checkbox"
                                id="select-all"
                                class="w-4 h-4 rounded border-slate-300 text-brand-gold focus:ring-brand-gold bg-slate-50"
                            />
                        </th>
                        <th
                            class="px-6 py-4 text-[10px] font-black uppercase tracking-widest text-slate-400"
                            >Producto</th
                        >
                        <th
                            class="px-6 py-4 text-[10px] font-black uppercase tracking-widest text-slate-400 text-right"
                            >Precio</th
                        >
                        <th
                            class="px-8 py-4 text-[10px] font-black uppercase tracking-widest text-slate-400 text-right"
                            >Disponibilidad</th
                        >
                    </tr>
                </thead>
                <tbody class="divide-y divide-slate-100">
                    {
                        allProducts?.map((product) => {
                            const isInCollection = assignedProductIds.includes(
                                product.id,
                            );

                            return (
                                <tr
                                    class={`group hover:bg-slate-50/50 transition-colors ${isInCollection ? "bg-brand-gold/5" : ""}`}
                                >
                                    <td class="px-6 py-4 w-10">
                                        <input
                                            type="checkbox"
                                            name="selected_products"
                                            value={product.id}
                                            data-in-collection={
                                                isInCollection
                                                    ? "true"
                                                    : "false"
                                            }
                                            class="product-checkbox w-4 h-4 rounded border-slate-300 text-brand-gold focus:ring-brand-gold"
                                        />
                                    </td>
                                    <td class="px-6 py-4">
                                        <div class="flex items-center gap-4">
                                            {product.images?.[0] ? (
                                                <div class="w-10 h-12 rounded-lg overflow-hidden bg-slate-100 border border-slate-100">
                                                    <img
                                                        src={product.images[0]}
                                                        class="w-full h-full object-cover"
                                                    />
                                                </div>
                                            ) : (
                                                <div class="w-10 h-12 rounded-lg bg-slate-100 flex items-center justify-center" />
                                            )}
                                            <div>
                                                <p class="font-bold text-slate-800 line-clamp-1">
                                                    {product.name}
                                                </p>
                                                <p class="text-xs text-slate-400 font-medium">
                                                    Ref: {product.id}
                                                </p>
                                            </div>
                                        </div>
                                    </td>
                                    <td class="px-6 py-4 text-right font-bold text-slate-800">
                                        {formatPrice(product.price)}
                                    </td>
                                    <td class="px-8 py-4 text-right">
                                        <form method="POST">
                                            <input
                                                type="hidden"
                                                name="product_id"
                                                value={product.id}
                                            />
                                            {isInCollection ? (
                                                <>
                                                    <input
                                                        type="hidden"
                                                        name="action"
                                                        value="remove"
                                                    />
                                                    <button
                                                        type="submit"
                                                        class="inline-flex items-center gap-2 px-4 py-2 bg-slate-900 border border-transparent text-white text-xs font-bold rounded-xl shadow-lg hover:bg-red-500 transition-all"
                                                    >
                                                        <svg
                                                            class="w-3 h-3 text-brand-gold group-hover:block"
                                                            fill="none"
                                                            viewBox="0 0 24 24"
                                                            stroke="currentColor"
                                                        >
                                                            <path
                                                                stroke-linecap="round"
                                                                stroke-linejoin="round"
                                                                stroke-width="3"
                                                                d="M5 13l4 4L19 7"
                                                            />
                                                        </svg>
                                                        Perteneciente
                                                    </button>
                                                </>
                                            ) : (
                                                <>
                                                    <input
                                                        type="hidden"
                                                        name="action"
                                                        value="add"
                                                    />
                                                    <button
                                                        type="submit"
                                                        class="px-4 py-2 bg-white border border-slate-200 text-slate-500 text-xs font-bold rounded-xl hover:text-slate-900 hover:border-slate-300 transition-all"
                                                    >
                                                        + Añadir
                                                    </button>
                                                </>
                                            )}
                                        </form>
                                    </td>
                                </tr>
                            );
                        })
                    }
                </tbody>
            </table>
        </div>
    </div>
</AdminLayout>

<script>
    import { showModal } from "../../../stores/modalStore";

    document.addEventListener("DOMContentLoaded", () => {
        const selectAllCheckbox = document.getElementById(
            "select-all",
        ) as HTMLInputElement;
        const productCheckboxes = document.querySelectorAll(
            ".product-checkbox",
        ) as NodeListOf<HTMLInputElement>;

        const bulkAddBtn = document.getElementById(
            "bulk-add-btn",
        ) as HTMLButtonElement;
        const bulkAddForm = document.getElementById(
            "bulk-add-form",
        ) as HTMLFormElement;
        const addCountSpan = document.getElementById("add-count");
        const addProductIdsInput = document.getElementById(
            "add-product-ids",
        ) as HTMLInputElement;

        const bulkRemoveBtn = document.getElementById(
            "bulk-remove-btn",
        ) as HTMLButtonElement;
        const bulkRemoveForm = document.getElementById(
            "bulk-remove-form",
        ) as HTMLFormElement;
        const removeCountSpan = document.getElementById("remove-count");
        const removeProductIdsInput = document.getElementById(
            "remove-product-ids",
        ) as HTMLInputElement;

        function updateActionButtons() {
            let toAddCount = 0;
            let toRemoveCount = 0;
            const toAddIds: string[] = [];
            const toRemoveIds: string[] = [];

            productCheckboxes.forEach((cb) => {
                if (cb.checked) {
                    const inCollection = cb.dataset.inCollection === "true";
                    if (inCollection) {
                        toRemoveCount++;
                        toRemoveIds.push(cb.value);
                    } else {
                        toAddCount++;
                        toAddIds.push(cb.value);
                    }
                }
            });

            // Update Add Button
            if (toAddCount > 0) {
                bulkAddBtn.disabled = false;
                bulkAddBtn.classList.remove("hidden");
                if (addCountSpan)
                    addCountSpan.textContent = toAddCount.toString();
                addProductIdsInput.value = toAddIds.join(",");
            } else {
                bulkAddBtn.disabled = true;
                bulkAddBtn.classList.add("hidden");
                addProductIdsInput.value = "";
            }

            // Update Remove Button
            if (toRemoveCount > 0) {
                bulkRemoveBtn.disabled = false;
                bulkRemoveBtn.classList.remove("hidden");
                if (removeCountSpan)
                    removeCountSpan.textContent = toRemoveCount.toString();
                removeProductIdsInput.value = toRemoveIds.join(",");
            } else {
                bulkRemoveBtn.disabled = true;
                bulkRemoveBtn.classList.add("hidden");
                removeProductIdsInput.value = "";
            }
        }

        if (selectAllCheckbox) {
            selectAllCheckbox.addEventListener("change", (e) => {
                const target = e.target as HTMLInputElement;
                productCheckboxes.forEach((cb) => {
                    cb.checked = target.checked;
                });
                updateActionButtons();
            });
        }

        productCheckboxes.forEach((cb) => {
            cb.addEventListener("change", () => {
                // Determine logic for selectAll
                const allChecked = Array.from(productCheckboxes).every(
                    (c) => c.checked,
                );
                const someChecked = Array.from(productCheckboxes).some(
                    (c) => c.checked,
                );

                if (selectAllCheckbox) {
                    selectAllCheckbox.checked = allChecked;
                    selectAllCheckbox.indeterminate =
                        !allChecked && someChecked;
                }

                updateActionButtons();
            });
        });

        // Initialize state
        updateActionButtons();

        // Handle bulk form submissions with custom modal
        if (bulkAddForm && bulkAddBtn) {
            bulkAddForm.addEventListener("submit", (e) => {
                e.preventDefault();
                showModal({
                    title: "Añadir a Colección",
                    message: `¿Estás seguro de añadir los ${addCountSpan?.textContent || "0"} productos seleccionados a esta colección?`,
                    type: "confirm",
                    confirmText: "Añadir Productos",
                    onConfirm: async () => {
                        bulkAddForm.submit();
                    },
                });
            });
        }

        if (bulkRemoveForm && bulkRemoveBtn) {
            bulkRemoveForm.addEventListener("submit", (e) => {
                e.preventDefault();
                showModal({
                    title: "Quitar de Colección",
                    message: `¿Estás seguro de quitar los ${removeCountSpan?.textContent || "0"} productos seleccionados de esta colección?`,
                    type: "delete",
                    confirmText: "Quitar Productos",
                    onConfirm: async () => {
                        bulkRemoveForm.submit();
                    },
                });
            });
        }
    });
</script>
