---
import AdminLayout from "../../../layouts/AdminLayout.astro";
import { supabase } from "../../../lib/supabase";
import { createClient } from "@supabase/supabase-js";

const { id } = Astro.params;

const accessToken = Astro.cookies.get("sb-access-token")?.value;
if (!accessToken) return Astro.redirect("/login");

const {
    data: { user: adminUser },
} = await supabase.auth.getUser(accessToken);
if (!adminUser || adminUser.app_metadata?.role !== "admin")
    return Astro.redirect("/");

const supabaseAdmin = createClient(
    import.meta.env.PUBLIC_SUPABASE_URL,
    import.meta.env.SUPABASE_SERVICE_ROLE_KEY,
);

// 1. Obtener perfil de la base de datos (Contiene facturación)
const { data: profile } = await supabaseAdmin
    .from("profiles")
    .select("*")
    .eq("id", id)
    .single();

if (!profile) return Astro.redirect("/admin/clients");

// 2. Obtener datos de la cuenta (Contiene envío y metadatos de perfil)
const {
    data: { user: authUser },
} = await supabaseAdmin.auth.admin.getUserById(id as string);

// 3. Obtener pedidos
const { data: orders } = await supabaseAdmin
    .from("orders")
    .select("*")
    .eq("user_id", id)
    .order("created_at", { ascending: false });

// 4. Obtener cupones (asignados y usados)
const { data: assignedCoupons } = await supabaseAdmin
    .from("cupon_asignaciones")
    .select("*, cupon:cupones(*)")
    .eq("cliente_id", id);

const { data: usedCoupons } = await supabaseAdmin
    .from("cupon_usos")
    .select("*, cupon:cupones(*)")
    .eq("user_id", id);

// Identificar cupones disponibles (asignados pero no usados)
const usedCouponIds = new Set(usedCoupons?.map((u) => u.cupon_id) || []);
const availableCoupons =
    assignedCoupons?.filter((a) => !usedCouponIds.has(a.cupon_id)) || [];

const displayName =
    profile.billing_razon_social ||
    profile.nombre ||
    authUser?.user_metadata?.name ||
    profile.email.split("@")[0];

const address =
    profile.billing_direccion ||
    authUser?.user_metadata?.address ||
    "No especificada";
const city = profile.billing_ciudad || authUser?.user_metadata?.city || "";
const zip = profile.billing_codigo_postal || authUser?.user_metadata?.zip || "";

const totalSpent =
    orders?.reduce(
        (acc: number, curr: any) =>
            acc + (curr.status !== "cancelled" ? curr.total_amount : 0),
        0,
    ) || 0;
const formatPrice = (cents: number) => (cents / 100).toFixed(2) + "€";
---

<AdminLayout title={`Cliente: ${displayName}`}>
    <div class="space-y-8 animate-in fade-in duration-500">
        <a
            href="/admin/clients"
            class="text-xs font-black text-slate-400 hover:text-brand-gold flex items-center gap-2"
        >
            ← VOLVER AL LISTADO
        </a>

        <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
            <div class="space-y-6">
                <!-- Card Principal -->
                <div
                    class="bg-white p-10 rounded-[3rem] border border-slate-100 shadow-sm text-center"
                >
                    <div
                        class="w-20 h-20 bg-slate-900 text-white rounded-3xl mx-auto flex items-center justify-center text-3xl font-black mb-6"
                    >
                        {displayName.charAt(0).toUpperCase()}
                    </div>
                    <h3 class="text-2xl font-black text-slate-800">
                        {displayName}
                    </h3>
                    <p class="text-sm text-slate-400 font-medium">
                        {profile.email}
                    </p>
                </div>

                <!-- Ubicación y Datos (Con Fallback) -->
                <div
                    class="bg-white p-8 rounded-3xl border border-slate-100 shadow-sm space-y-6"
                >
                    <div>
                        <p
                            class="text-[10px] font-black text-slate-400 uppercase tracking-widest border-b border-slate-50 pb-2 mb-4"
                        >
                            Ubicación y Contacto
                        </p>
                        <div class="space-y-4">
                            <div>
                                <p class="text-xs text-slate-400">
                                    Dirección Activa
                                </p>
                                <p class="font-bold text-slate-700">
                                    {address}
                                </p>
                                <p class="font-bold text-slate-700">
                                    {zip}
                                    {city}
                                </p>
                                {
                                    profile.billing_direccion ? (
                                        <span class="text-[8px] bg-blue-50 text-blue-500 px-2 py-0.5 rounded uppercase font-bold">
                                            Datos de Facturación
                                        </span>
                                    ) : (
                                        <span class="text-[8px] bg-slate-50 text-slate-400 px-2 py-0.5 rounded uppercase font-bold">
                                            Dirección de Envío
                                        </span>
                                    )
                                }
                            </div>
                            <div>
                                <p class="text-xs text-slate-400">Teléfono</p>
                                <p class="font-bold text-slate-700">
                                    {profile.telefono || "No disponible"}
                                </p>
                            </div>
                        </div>
                    </div>

                    <div>
                        <p
                            class="text-[10px] font-black text-slate-400 uppercase tracking-widest border-b border-slate-50 pb-2 mb-4"
                        >
                            Identificación Fiscal
                        </p>
                        <p class="text-xs text-slate-400">NIF/DNI/CIF</p>
                        <p class="font-bold text-slate-700 uppercase">
                            {profile.billing_nif || "No registrado"}
                        </p>
                    </div>
                </div>
            </div>

            <div class="lg:col-span-2 space-y-8">
                <div class="grid grid-cols-2 gap-6">
                    <div
                        class="bg-brand-gold p-8 rounded-[2rem] text-white shadow-xl shadow-brand-gold/10"
                    >
                        <p class="text-[10px] font-black uppercase opacity-80">
                            Pedidos Totales
                        </p>
                        <p class="text-4xl font-black">{orders?.length || 0}</p>
                    </div>
                    <div
                        class="bg-slate-900 p-8 rounded-[2rem] text-white shadow-xl shadow-slate-900/10"
                    >
                        <p class="text-[10px] font-black uppercase opacity-80">
                            Gasto en Tienda
                        </p>
                        <p class="text-4xl font-black">
                            {formatPrice(totalSpent)}
                        </p>
                    </div>
                </div>

                <!-- Cupones -->
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div
                        class="bg-white rounded-[2rem] border border-slate-100 shadow-sm p-8"
                    >
                        <h4
                            class="text-sm font-black text-slate-800 uppercase tracking-widest mb-6 flex items-center gap-2"
                        >
                            <svg
                                class="w-4 h-4 text-green-500"
                                fill="none"
                                viewBox="0 0 24 24"
                                stroke="currentColor"
                            >
                                <path
                                    stroke-linecap="round"
                                    stroke-linejoin="round"
                                    stroke-width="2"
                                    d="M15 5v2m0 4v2m0 4v2M5 5a2 2 0 00-2 2v3a2 2 0 110 4v3a2 2 0 002 2h14a2 2 0 002-2v-3a2 2 0 110-4V7a2 2 0 00-2-2H5z"
                                ></path>
                            </svg>
                            Cupones Disponibles
                        </h4>
                        {
                            availableCoupons.length > 0 ? (
                                <div class="space-y-3">
                                    {availableCoupons.map((a: any) => (
                                        <div class="flex justify-between items-center p-3 bg-green-50/50 border border-green-100 rounded-xl">
                                            <span class="font-mono font-bold text-green-700 text-sm">
                                                {a.cupon?.codigo}
                                            </span>
                                            <span class="text-[10px] font-black text-green-600 bg-white px-2 py-0.5 rounded shadow-sm">
                                                {a.cupon?.descuento_porcentaje}%
                                                OFF
                                            </span>
                                        </div>
                                    ))}
                                </div>
                            ) : (
                                <p class="text-xs text-slate-400 italic">
                                    No tiene cupones disponibles.
                                </p>
                            )
                        }
                    </div>

                    <div
                        class="bg-white rounded-[2rem] border border-slate-100 shadow-sm p-8"
                    >
                        <h4
                            class="text-sm font-black text-slate-800 uppercase tracking-widest mb-6 flex items-center gap-2"
                        >
                            <svg
                                class="w-4 h-4 text-slate-400"
                                fill="none"
                                viewBox="0 0 24 24"
                                stroke="currentColor"
                            >
                                <path
                                    stroke-linecap="round"
                                    stroke-linejoin="round"
                                    stroke-width="2"
                                    d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-3 7h3m-3 4h3m-6-4h.01M9 16h.01"
                                ></path>
                            </svg>
                            Historial de Uso
                        </h4>
                        {
                            usedCoupons && usedCoupons.length > 0 ? (
                                <div class="space-y-3">
                                    {usedCoupons.map((u: any) => (
                                        <div class="flex justify-between items-center p-3 bg-slate-50 border border-slate-100 rounded-xl">
                                            <div>
                                                <p class="font-mono font-bold text-slate-700 text-sm leading-none">
                                                    {u.cupon?.codigo}
                                                </p>
                                                <p class="text-[8px] text-slate-400 uppercase font-black mt-1">
                                                    {new Date(
                                                        u.created_at,
                                                    ).toLocaleDateString(
                                                        "es-ES",
                                                    )}
                                                </p>
                                            </div>
                                            <span class="text-[10px] font-black text-slate-400">
                                                -{formatPrice(u.amount_saved)}
                                            </span>
                                        </div>
                                    ))}
                                </div>
                            ) : (
                                <p class="text-xs text-slate-400 italic">
                                    Aún no ha canjeado cupones.
                                </p>
                            )
                        }
                    </div>
                </div>

                <div
                    class="bg-white rounded-[2.5rem] border border-slate-100 shadow-sm overflow-hidden"
                >
                    <div
                        class="p-8 border-b border-slate-50 flex justify-between items-center bg-slate-50/20"
                    >
                        <h4
                            class="font-black text-slate-800 uppercase tracking-tighter"
                        >
                            Historial de Pedidos
                        </h4>
                        <span
                            id="sort-indicator"
                            class="text-[10px] font-bold text-brand-gold bg-brand-gold/5 px-3 py-1 rounded-full border border-brand-gold/10"
                            >ORDENADO POR FECHA (DESC)</span
                        >
                    </div>
                    {
                        orders && orders.length > 0 ? (
                            <div class="overflow-x-auto">
                                <table
                                    class="w-full text-left"
                                    id="orders-table"
                                >
                                    <thead class="bg-slate-50/50 text-[9px] font-black uppercase tracking-widest text-slate-400">
                                        <tr>
                                            <th
                                                class="px-8 py-4 cursor-pointer hover:text-brand-gold transition-colors select-none sort-header"
                                                data-sort="id"
                                            >
                                                <div class="flex items-center gap-1">
                                                    ID
                                                    <svg
                                                        class="w-2.5 h-2.5 opa-0"
                                                        fill="none"
                                                        viewBox="0 0 24 24"
                                                        stroke="currentColor"
                                                    >
                                                        <path
                                                            stroke-linecap="round"
                                                            stroke-linejoin="round"
                                                            stroke-width="4"
                                                            d="M7 11l5-5m0 0l5 5m-5-5v12"
                                                        />
                                                    </svg>
                                                </div>
                                            </th>
                                            <th
                                                class="px-6 py-4 cursor-pointer hover:text-brand-gold transition-colors select-none sort-header"
                                                data-sort="date"
                                            >
                                                <div class="flex items-center gap-1">
                                                    Fecha
                                                    <svg
                                                        class="w-2.5 h-2.5 text-brand-gold"
                                                        fill="none"
                                                        viewBox="0 0 24 24"
                                                        stroke="currentColor"
                                                    >
                                                        <path
                                                            stroke-linecap="round"
                                                            stroke-linejoin="round"
                                                            stroke-width="4"
                                                            d="M17 13l-5 5m0 0l-5-5m5 5V6"
                                                        />
                                                    </svg>
                                                </div>
                                            </th>
                                            <th
                                                class="px-6 py-4 cursor-pointer hover:text-brand-gold transition-colors select-none sort-header"
                                                data-sort="status"
                                            >
                                                <div class="flex items-center gap-1">
                                                    Estado
                                                    <svg
                                                        class="w-2.5 h-2.5 opa-0"
                                                        fill="none"
                                                        viewBox="0 0 24 24"
                                                        stroke="currentColor"
                                                    >
                                                        <path
                                                            stroke-linecap="round"
                                                            stroke-linejoin="round"
                                                            stroke-width="4"
                                                            d="M7 11l5-5m0 0l5 5m-5-5v12"
                                                        />
                                                    </svg>
                                                </div>
                                            </th>
                                            <th
                                                class="px-8 py-4 text-right cursor-pointer hover:text-brand-gold transition-colors select-none sort-header"
                                                data-sort="total"
                                            >
                                                <div class="flex items-center justify-end gap-1">
                                                    Total
                                                    <svg
                                                        class="w-2.5 h-2.5 opa-0"
                                                        fill="none"
                                                        viewBox="0 0 24 24"
                                                        stroke="currentColor"
                                                    >
                                                        <path
                                                            stroke-linecap="round"
                                                            stroke-linejoin="round"
                                                            stroke-width="4"
                                                            d="M7 11l5-5m0 0l5 5m-5-5v12"
                                                        />
                                                    </svg>
                                                </div>
                                            </th>
                                        </tr>
                                    </thead>
                                    <tbody
                                        class="divide-y divide-slate-50"
                                        id="orders-body"
                                    >
                                        {orders.map((order: any) => (
                                            <tr
                                                class="hover:bg-slate-50/50 transition-colors order-row"
                                                data-id={order.id}
                                                data-date={order.created_at}
                                                data-status={order.status}
                                                data-total={order.total_amount}
                                            >
                                                <td class="px-8 py-5 font-mono text-xs font-bold text-slate-400">
                                                    #
                                                    {order.id
                                                        .toString()
                                                        .padStart(5, "0")}
                                                </td>
                                                <td class="px-6 py-5 text-sm font-medium text-slate-700">
                                                    {new Date(
                                                        order.created_at,
                                                    ).toLocaleDateString(
                                                        "es-ES",
                                                    )}
                                                </td>
                                                <td class="px-6 py-5">
                                                    <span class="px-3 py-1 bg-white border border-slate-100 text-slate-600 rounded-lg text-[9px] font-black uppercase">
                                                        {order.status}
                                                    </span>
                                                </td>
                                                <td class="px-8 py-5 text-right font-black text-slate-900">
                                                    {formatPrice(
                                                        order.total_amount,
                                                    )}
                                                </td>
                                            </tr>
                                        ))}
                                    </tbody>
                                </table>
                            </div>
                        ) : (
                            <div class="p-20 text-center">
                                <p class="text-slate-400 italic text-sm font-medium">
                                    Este cliente aún no ha registrado compras.
                                </p>
                            </div>
                        )
                    }
                </div>
            </div>
        </div>
    </div>

    <script is:inline>
        function initializeSorting() {
            const tableBody = document.getElementById("orders-body");
            const headers = document.querySelectorAll(".sort-header");
            const indicator = document.getElementById("sort-indicator");

            if (!tableBody || !headers) return;

            let currentSort = { column: "date", direction: "desc" };

            const columnNames = {
                id: "ID",
                date: "FECHA",
                status: "ESTADO",
                total: "TOTAL",
            };

            headers.forEach((header) => {
                header.addEventListener("click", () => {
                    const column = header.getAttribute("data-sort");
                    const direction =
                        currentSort.column === column &&
                        currentSort.direction === "asc"
                            ? "desc"
                            : "asc";

                    currentSort = { column, direction };

                    // Actualizar indicadores visuales
                    headers.forEach((h) => {
                        const svg = h.querySelector("svg");
                        if (h === header) {
                            svg.style.opacity = "1";
                            svg.innerHTML =
                                direction === "asc"
                                    ? '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="4" d="M7 11l5-5m0 0l5 5m-5-5v12"/>'
                                    : '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="4" d="M17 13l-5 5m0 0l-5-5m5 5V6"/>';
                        } else {
                            svg.style.opacity = "0";
                        }
                    });

                    if (indicator) {
                        indicator.innerText = `ORDENADO POR ${columnNames[column]} (${direction.toUpperCase()})`;
                    }

                    // Ordenar filas
                    const rows = Array.from(
                        document.querySelectorAll(".order-row"),
                    );
                    const sortedRows = rows.sort((a, b) => {
                        let valA = a.getAttribute(`data-${column}`);
                        let valB = b.getAttribute(`data-${column}`);

                        if (column === "total" || column === "id") {
                            valA = parseFloat(valA);
                            valB = parseFloat(valB);
                        } else if (column === "date") {
                            valA = new Date(valA).getTime();
                            valB = new Date(valB).getTime();
                        }

                        if (valA < valB) return direction === "asc" ? -1 : 1;
                        if (valA > valB) return direction === "asc" ? 1 : -1;
                        return 0;
                    });

                    // Re-insertar filas ordenadas
                    tableBody.innerHTML = "";
                    sortedRows.forEach((row) => tableBody.appendChild(row));
                });
            });
        }

        // Ejecutar en carga y cambios de Astro
        document.addEventListener("DOMContentLoaded", initializeSorting);
        document.addEventListener("astro:after-swap", initializeSorting);
        initializeSorting();
    </script>
</AdminLayout>
