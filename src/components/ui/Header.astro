---
interface Props {}

import { supabase } from "../../lib/supabase";
import HeaderCounter from "../islands/HeaderCounter";

const accessToken = Astro.cookies.get("sb-access-token")?.value;
let user = null;

if (accessToken) {
  try {
    const { data } = await supabase.auth.getUser(accessToken);
    if (data?.user) {
      user = data.user;
    }
  } catch (error) {
    // Token inválido
  }
}

const userName =
  user?.user_metadata?.name || user?.email?.split("@")[0] || "Usuario";
---

<!-- Top Banner / Announcement Bar -->
<div class="bg-brand-black text-white py-2 px-4 text-center overflow-hidden">
  <div class="animate-marquee whitespace-nowrap inline-block">
    <span class="text-[10px] font-bold uppercase tracking-[0.3em] mx-12">Envío gratuito en pedidos superiores a 50€</span>
    <span class="text-[10px] font-bold uppercase tracking-[0.3em] mx-12">Nueva Colección Otoño/Invierno 2026 ya disponible</span>
    <span class="text-[10px] font-bold uppercase tracking-[0.3em] mx-12">Descuento exclusivo de bienvenida del 10% con el código: WELCOME10</span>
  </div>
</div>

<header
  id="main-header"
  class="sticky top-0 z-[9999] bg-white/80 backdrop-blur-md border-b border-gray-100 transition-all duration-300"
>
  <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
    <div class="flex items-center justify-between h-20">
      <!-- Left: Mobile Menu Trigger (lg:hidden) & Desktop Navigation -->
      <div class="flex lg:hidden flex-1">
        <button id="mobile-menu-trigger" class="p-2 -ml-2 text-slate-700 hover:text-brand-gold transition-colors">
          <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16" />
          </svg>
        </button>
      </div>

      <nav class="hidden lg:flex items-center gap-8 flex-1">
        <a
          href="/"
          class="text-xs font-bold uppercase tracking-widest text-slate-900 hover:text-brand-gold transition-colors relative group"
        >
          Inicio
          <span class="absolute -bottom-1 left-0 w-0 h-px bg-brand-gold transition-all group-hover:w-full"></span>
        </a>

        <div class="relative group/tienda">
          <button
            type="button"
            class="nav-trigger text-xs font-bold uppercase tracking-widest text-slate-900 hover:text-brand-gold transition-colors flex items-center gap-1.5"
            data-trigger="tienda"
          >
            Tienda
            <svg class="nav-arrow w-3 h-3 transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5" d="M19 9l-7 7-7-7"></path>
            </svg>
          </button>
          <!-- Mega Menu Dropdown -->
          <div
            class="nav-dropdown hidden absolute left-0 top-full mt-[1.25rem] w-[900px] -ml-[100px] rounded-3xl bg-white shadow-2xl ring-1 ring-black/5 z-[10000] p-10 border border-gray-50 flex gap-12 animate-slide-up"
            data-menu="tienda"
          >
            <div class="flex-1 grid grid-cols-3 gap-12 text-left">
              <!-- Ropa -->
              <div>
                <p class="text-[10px] font-black uppercase tracking-[0.2em] text-brand-gold mb-6 border-b border-brand-gold/10 pb-2">Ropa</p>
                <div class="space-y-3">
                  {['Camisetas', 'Polos', 'Camisas', 'Sudaderas', 'Jerseys', 'Chaquetas', 'Abrigos', 'Pantalones'].map(item => (
                    <a href={`/catalogo/ropa/${item.toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g, "")}`} class="block text-sm text-slate-500 hover:text-brand-black hover:translate-x-1 transition-all">
                      {item}
                    </a>
                  ))}
                </div>
              </div>
              <!-- Calzado -->
              <div>
                <p class="text-[10px] font-black uppercase tracking-[0.2em] text-brand-gold mb-6 border-b border-brand-gold/10 pb-2">Calzado</p>
                <div class="space-y-3">
                  {['Zapatillas', 'Zapatos casual', 'Zapatos vestir', 'Botines', 'Sandalias'].map(item => (
                    <a href={`/catalogo/calzado/${item.toLowerCase().replace(' ', '-')}`} class="block text-sm text-slate-500 hover:text-brand-black hover:translate-x-1 transition-all">
                      {item}
                    </a>
                  ))}
                </div>
                <div class="mt-10 p-5 rounded-2xl bg-slate-50 border border-slate-100">
                  <p class="text-[10px] font-bold text-slate-900 uppercase tracking-widest mb-2 italic">Pro-Tip</p>
                  <p class="text-xs text-slate-500 leading-relaxed">Pruébate nuestro calzado en casa. Devoluciones gratuitas en 30 días.</p>
                </div>
              </div>
              <!-- Complementos -->
              <div>
                <p class="text-[10px] font-black uppercase tracking-[0.2em] text-brand-gold mb-6 border-b border-brand-gold/10 pb-2">Complementos</p>
                <div class="space-y-3">
                  {['Gorras y gorros', 'Bolsos y mochilas', 'Cinturones', 'Gafas', 'Relojería'].map(item => (
                    <a href="/catalogo/complementos" class="block text-sm text-slate-500 hover:text-brand-black hover:translate-x-1 transition-all">
                      {item}
                    </a>
                  ))}
                </div>
                <div class="mt-8">
                  <a href="/catalogo" class="flex items-center justify-between p-4 rounded-xl bg-brand-black text-white hover:bg-brand-gold transition-all group/all">
                    <span class="text-[10px] font-bold uppercase tracking-widest">Colección Completa</span>
                    <svg class="w-4 h-4 group-hover/all:translate-x-1 transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 7l5 5m0 0l-5 5m5-5H6" />
                    </svg>
                  </a>
                </div>
              </div>
            </div>
          </div>
        </div>

        <a
          href="/ofertas"
          class="text-xs font-bold uppercase tracking-widest text-red-500 hover:text-red-600 transition-colors flex items-center gap-2 group"
        >
          <span class="relative">
            Ofertas
            <span class="absolute -bottom-1 left-0 w-0 h-px bg-red-500 transition-all group-hover:w-full"></span>
          </span>
          <span class="flex h-2 w-2 rounded-full bg-red-500 animate-pulse"></span>
        </a>
      </nav>

      <!-- Center: Logo -->
      <div class="flex-shrink-0 flex items-center justify-center">
        <a
          href="/"
          class="text-2xl lg:text-3xl font-serif font-black tracking-tighter hover:scale-[1.02] transition-transform flex items-center"
        >
          <span class="text-slate-900">Fashion</span><span class="text-brand-gold ml-1">Store</span>
        </a>
      </div>

      <!-- Right: Actions & Search -->
      <div class="flex-1 flex items-center justify-end gap-2 lg:gap-5">
        <!-- Search Desktop -->
        <div class="relative hidden lg:block">
          <div class="flex items-center h-10 px-4 bg-slate-50 border border-slate-100 rounded-full focus-within:bg-white focus-within:ring-2 focus-within:ring-brand-gold/20 focus-within:border-brand-gold transition-all w-48 lg:w-64">
            <svg class="w-4 h-4 text-slate-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
            </svg>
            <input
              id="search-input"
              type="text"
              placeholder="Buscar..."
              class="w-full ml-2 bg-transparent text-sm text-slate-700 placeholder:text-slate-400 focus:outline-none"
            />
          </div>
          <!-- Search Results Dropdown -->
          <div
            id="search-results"
            class="hidden absolute top-full right-0 mt-4 w-[350px] bg-white rounded-2xl shadow-2xl border border-gray-100 overflow-hidden z-[10002] animate-slide-up"
          >
            <div id="search-results-content" class="py-2"></div>
            <div class="bg-slate-50 p-3 text-center border-t border-slate-100">
               <span class="text-[10px] text-slate-400 uppercase font-black tracking-widest">Presiona enter para ver más</span>
            </div>
          </div>
        </div>

        <!-- Search Mobile Trigger -->
        <button id="mobile-search-trigger" class="lg:hidden p-2 rounded-full hover:bg-slate-50 transition-colors">
          <svg class="w-5 h-5 text-slate-700" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
          </svg>
        </button>

        <!-- Icons Group -->
        <div class="flex items-center gap-1">
          <!-- Ayuda / Soporte -->
          {user && (
            <a href="/ayuda" class="hidden sm:block p-2 rounded-full hover:bg-slate-50 transition-colors relative group" title="Ayuda y Soporte">
              <svg class="w-5 h-5 text-slate-700 group-hover:text-brand-blue" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.8" d="M8.228 9c.549-1.165 2.03-2 3.772-2 2.21 0 4 1.343 4 3 0 1.4-1.278 2.575-3.006 2.907-.542.104-.994.54-.994 1.093m0 3h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
              </svg>
            </a>
          )}

          <!-- Favorites -->
          <a href="/favoritos" class="p-2 rounded-full hover:bg-slate-50 transition-colors relative group" title="Favoritos">
            <svg class="w-5 h-5 text-slate-700 group-hover:text-red-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.8" d="M4.318 6.318a4.5 4.5 0 000 6.364L12 20.364l7.682-7.682a4.5 4.5 0 00-6.364-6.364L12 7.636l-1.318-1.318a4.5 4.5 0 00-6.364 0z" />
            </svg>
            <HeaderCounter client:load type="favorite" />
          </a>

          <!-- User / Auth -->
          <div class="relative" id="profile-menu">
            {user ? (
              <button id="profile-trigger" class="flex items-center focus:outline-none p-1 ml-1 relative group">
                 <div class="w-8 h-8 rounded-full bg-slate-100 border border-slate-200 flex items-center justify-center overflow-hidden hover:border-brand-gold transition-colors">
                    <span class="text-xs font-bold text-slate-600 uppercase">
                      {userName.charAt(0)}
                    </span>
                 </div>
                 <HeaderCounter client:load type="notification" />
              </button>
              <!-- Profile Dropdown -->
              <div id="profile-dropdown" class="hidden absolute right-0 top-full mt-4 w-64 rounded-2xl bg-white shadow-2xl border border-slate-50 py-3 z-[10000] animate-slide-up">
                 <div class="px-6 py-4 border-b border-slate-50">
                    <p class="text-[10px] text-slate-400 font-black uppercase tracking-widest mb-1">Tu cuenta</p>
                    <p class="text-sm font-bold text-slate-800 truncate">{userName}</p>
                 </div>
                 <div class="py-2">
                    <a href="/mi-cuenta" class="flex items-center px-6 py-2.5 text-sm text-slate-600 hover:bg-slate-50 hover:text-brand-black transition-all">Perfil</a>
                    <a href="/mensajes" class="flex items-center justify-between px-6 py-2.5 text-sm text-slate-600 hover:bg-slate-50 hover:text-brand-black transition-all group/msg relative">
                       <span>Mis Mensajes</span>
                       <HeaderCounter client:load type="inquiry" />
                    </a>
                    <a href="/mis-pedidos" class="flex items-center px-6 py-2.5 text-sm text-slate-600 hover:bg-slate-50 hover:text-brand-black transition-all">Pedidos</a>
                    <a href="/mis-cupones" class="flex items-center justify-between px-6 py-2.5 text-sm text-slate-600 hover:bg-slate-50 hover:text-brand-black transition-all group/coupons relative">
                       <span>Mis Cupones</span>
                       <HeaderCounter client:load type="coupon_notification" />
                    </a>
                    {user?.app_metadata?.role === 'admin' && (
                      <div class="mt-2 pt-2 border-t border-slate-50">
                        <a href="/admin" class="flex items-center px-6 py-2.5 text-sm font-black text-brand-gold hover:bg-slate-900 hover:text-white transition-all">Admin Dashboard</a>
                      </div>
                    )}
                 </div>
                 <div class="mt-2 pt-2 border-t border-slate-50">
                    <button id="logout-button" class="w-full text-left px-6 py-3 text-sm text-red-500 font-bold hover:bg-red-50 transition-colors">Cerrar Sesión</button>
                 </div>
              </div>
            ) : (
              <a href="/login" class="ml-1 px-3 py-2 bg-brand-black text-white text-[9px] sm:text-[10px] font-black uppercase tracking-[0.1em] sm:tracking-[0.2em] rounded-full hover:bg-brand-gold hover:shadow-lg transition-all">
                Login
              </a>
            )}
          </div>

          <!-- Cart -->
          <button id="cart-button" class="p-2 ml-1 rounded-full bg-slate-50 hover:bg-brand-gold group transition-all relative">
            <svg class="w-5 h-5 text-slate-700 group-hover:text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.8" d="M16 11V7a4 4 0 00-8 0v4M5 9h14l1 12H4L5 9z" />
            </svg>
            <HeaderCounter client:load type="cart" dark />
          </button>
        </div>
      </div>
    </div>

    <!-- Mobile Search Overlay (Expandable) -->
    <div id="mobile-search-bar" class="hidden lg:hidden pb-4 px-2 animate-slide-up">
      <div class="flex items-center h-12 px-4 bg-slate-50 border border-slate-100 rounded-2xl focus-within:bg-white focus-within:ring-2 focus-within:ring-brand-gold/20 focus-within:border-brand-gold transition-all">
        <svg class="w-4 h-4 text-slate-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
        </svg>
        <input
          id="search-input-mobile"
          type="text"
          placeholder="¿Qué estás buscando?"
          class="w-full ml-3 bg-transparent text-sm text-slate-700 focus:outline-none"
        />
        <button id="mobile-search-close" class="ml-2 text-slate-400 hover:text-slate-600">
          <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" /></svg>
        </button>
      </div>
      <!-- Mobile Search Results -->
      <div id="search-results-mobile" class="hidden mt-2 max-h-[60vh] overflow-y-auto bg-white rounded-2xl shadow-xl border border-gray-100 p-2 z-[10003]">
        <div id="search-results-content-mobile"></div>
      </div>
    </div>
  </div>
</header>

<!-- Mobile Navigation Drawer -->
<div id="mobile-menu" class="fixed inset-0 z-[10001] lg:hidden hidden">
  <div id="mobile-menu-overlay" class="absolute inset-0 bg-slate-900/60 backdrop-blur-sm transition-opacity duration-300 opacity-0"></div>
  <div id="mobile-menu-content" class="absolute inset-y-0 left-0 w-[85%] max-w-sm bg-white shadow-2xl flex flex-col transform -translate-x-full transition-transform duration-300 ease-out">
    <div class="h-20 flex items-center justify-between px-6 border-b border-gray-100">
      <a href="/" class="text-2xl font-serif font-black tracking-tighter">
        <span class="text-slate-900">Fashion</span><span class="text-brand-gold ml-1">Store</span>
      </a>
      <button id="mobile-menu-close" class="p-2 text-slate-500 hover:text-brand-gold transition-colors">
        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
        </svg>
      </button>
    </div>
    
    <nav class="flex-1 overflow-y-auto p-8">
      <div class="space-y-10">
        <!-- Main Links -->
        <div class="space-y-6">
          <p class="text-[10px] font-black uppercase tracking-[0.2em] text-slate-400">Explorar</p>
          <a href="/" class="block text-3xl font-bold text-slate-900 hover:text-brand-gold transition-colors">Inicio</a>
          <a href="/ofertas" class="block text-3xl font-bold text-red-500 hover:text-red-600 transition-colors flex items-center gap-3">
            Ofertas
            <span class="flex h-3 w-3 rounded-full bg-red-500 animate-pulse"></span>
          </a>
        </div>

        <!-- Categories -->
        <div class="space-y-6">
          <p class="text-[10px] font-black uppercase tracking-[0.2em] text-slate-400">Colecciones</p>
          <div class="space-y-4">
             <div class="space-y-3">
                <p class="text-sm font-black text-brand-gold uppercase tracking-widest">Tienda</p>
                <div class="pl-4 space-y-4 border-l-2 border-slate-100">
                  <a href="/catalogo/ropa" class="block text-xl font-bold text-slate-700 hover:text-brand-black transition-colors">Ropa</a>
                  <a href="/catalogo/calzado" class="block text-xl font-bold text-slate-700 hover:text-brand-black transition-colors">Calzado</a>
                  <a href="/catalogo/complementos" class="block text-xl font-bold text-slate-700 hover:text-brand-black transition-colors">Complementos</a>
                </div>
             </div>
          </div>
        </div>

        <!-- Footer Info -->
        <div class="pt-10 border-t border-slate-50 space-y-4">
          {!user && (
            <a href="/login" class="flex items-center justify-center p-4 bg-slate-900 text-white rounded-2xl font-bold text-sm tracking-widest uppercase">
              Iniciar Sesión
            </a>
          )}
          <p class="text-xs text-slate-400 text-center">FashionStore &copy; 2026<br/>Moda Masculina Premium</p>
        </div>
      </div>
    </nav>
  </div>
</div>

<style>
  @keyframes marquee {
    0% { transform: translateX(0); }
    100% { transform: translateX(-50%); }
  }
  .animate-marquee {
    display: inline-block;
    padding-left: 100%;
    animation: marquee 30s linear infinite;
  }
  .animate-marquee:hover {
    animation-play-state: paused;
  }
  
  .animate-slide-up {
    animation: slideUp 0.3s ease-out;
  }
  @keyframes slideUp {
    from { opacity: 0; transform: translateY(10px); }
    to { opacity: 1; transform: translateY(0); }
  }

  /* Mobile Nav Transitions */
  #mobile-menu-content.open {
    transform: translateX(0);
  }
  #mobile-menu-overlay.open {
    opacity: 1;
  }
</style>

<script>
  import { supabase } from "../../lib/supabase";
  import { isCartOpen, clearCart } from "../../stores/cartStore";
  import { clearFavorites } from "../../stores/favoriteStore";

  document.addEventListener("DOMContentLoaded", () => {
    // ---- Navegación Mobile ----
    const mobileMenuTrigger = document.getElementById("mobile-menu-trigger");
    const mobileMenuClose = document.getElementById("mobile-menu-close");
    const mobileMenu = document.getElementById("mobile-menu");
    const mobileMenuContent = document.getElementById("mobile-menu-content");
    const mobileMenuOverlay = document.getElementById("mobile-menu-overlay");

    const openMobileMenu = () => {
      mobileMenu?.classList.remove("hidden");
      setTimeout(() => {
        mobileMenuContent?.classList.add("open");
        mobileMenuOverlay?.classList.add("open");
      }, 10);
      document.body.style.overflow = "hidden";
    };

    const closeMobileMenu = () => {
      mobileMenuContent?.classList.remove("open");
      mobileMenuOverlay?.classList.remove("open");
      setTimeout(() => {
        mobileMenu?.classList.add("hidden");
      }, 300);
      document.body.style.overflow = "";
    };

    mobileMenuTrigger?.addEventListener("click", openMobileMenu);
    mobileMenuClose?.addEventListener("click", closeMobileMenu);
    mobileMenuOverlay?.addEventListener("click", closeMobileMenu);

    // ---- Búsqueda Mobile ----
    const mobileSearchTrigger = document.getElementById("mobile-search-trigger");
    const mobileSearchClose = document.getElementById("mobile-search-close");
    const mobileSearchBar = document.getElementById("mobile-search-bar");
    const mobileSearchInput = document.getElementById("search-input-mobile") as HTMLInputElement;

    mobileSearchTrigger?.addEventListener("click", () => {
      mobileSearchBar?.classList.remove("hidden");
      mobileSearchInput?.focus();
    });

    mobileSearchClose?.addEventListener("click", () => {
      mobileSearchBar?.classList.add("hidden");
      if (mobileSearchInput) mobileSearchInput.value = "";
      const results = document.getElementById("search-results-mobile");
      if (results) results.classList.add("hidden");
    });

    // ---- Carrito & Otros ----
    const cartButton = document.getElementById("cart-button");
    if (cartButton) {
      cartButton.addEventListener("click", () => {
        isCartOpen.set(true);
      });
    }

    const header = document.getElementById("main-header");
    if (!header) return;

    // Función para cerrar menús nav desktop
    const closeAllDesktopMenus = () => {
      header.querySelectorAll(".nav-dropdown").forEach((d) => d.classList.add("hidden"));
      header.querySelectorAll(".nav-trigger").forEach((t) => {
        t.setAttribute("aria-expanded", "false");
        const arrow = t.querySelector(".nav-arrow");
        if (arrow) arrow.classList.remove("rotate-180");
      });
    };

    // Mega Menu Desktop Logic
    header.querySelectorAll(".nav-trigger").forEach((trigger) => {
      trigger.addEventListener("click", (e) => {
        e.stopPropagation();
        const btn = trigger as HTMLElement;
        const key = btn.getAttribute("data-trigger");
        if (!key) return;

        const menu = header.querySelector(`[data-menu="${key}"]`) as HTMLElement;
        const isOpen = menu && !menu.classList.contains("hidden");

        closeAllDesktopMenus();
        const profileDropdown = document.getElementById("profile-dropdown");
        if (profileDropdown) profileDropdown.classList.add("hidden");
        
        if (!isOpen) {
          menu.classList.remove("hidden");
          btn.setAttribute("aria-expanded", "true");
          const arrow = btn.querySelector(".nav-arrow");
          if (arrow) arrow.classList.add("rotate-180");
        }
      });
    });

    // Menú de Perfil
    const profileTrigger = document.getElementById("profile-trigger");
    const profileDropdown = document.getElementById("profile-dropdown");
    const logoutBtn = document.getElementById("logout-button");

    if (profileTrigger && profileDropdown) {
      profileTrigger.addEventListener("click", (e) => {
        e.stopPropagation();
        const isHidden = profileDropdown.classList.contains("hidden");
        closeAllDesktopMenus();
        if (isHidden) profileDropdown.classList.remove("hidden");
        else profileDropdown.classList.add("hidden");
      });
    }

    // Logout
    if (logoutBtn) {
      logoutBtn.addEventListener("click", async (e) => {
        e.preventDefault();
        try {
          await supabase.auth.signOut();
        } catch (err) {
          console.error("Logout error", err);
        } finally {
          if (typeof clearCart === 'function') clearCart();
          if (typeof clearFavorites === 'function') clearFavorites();
          document.cookie = "sb-access-token=; Path=/; Max-Age=0; SameSite=Lax";
          document.cookie = "sb-refresh-token=; Path=/; Max-Age=0; SameSite=Lax";
          window.location.href = "/";
        }
      });
    }

    // Click fuera cierra todo
    document.addEventListener("click", (e) => {
      const target = e.target as Node;
      if (!header.contains(target)) {
        closeAllDesktopMenus();
        const profileDropdown = document.getElementById("profile-dropdown");
        if (profileDropdown) profileDropdown.classList.add("hidden");
      }
    });

    // ---- Sistema de Búsqueda ----
    const setupSearch = (input: HTMLInputElement, resultsDiv: HTMLElement, contentDiv: HTMLElement) => {
      let timeout: any;

      const formatPrice = (cents: number) => {
        return new Intl.NumberFormat("es-ES", { style: "currency", currency: "EUR" }).format(cents / 100);
      };

      input.addEventListener("input", async (e) => {
        const query = (e.target as HTMLInputElement).value.trim();
        clearTimeout(timeout);

        if (query.length < 2) {
          resultsDiv.classList.add("hidden");
          return;
        }

        timeout = setTimeout(async () => {
          try {
            const res = await fetch(`/api/search.json?q=${encodeURIComponent(query)}`);
            const data = await res.json();

            if (!data.success || !data.results || data.results.length === 0) {
              contentDiv.innerHTML = '<div class="px-4 py-3 text-sm text-gray-500 text-center">No se encontró nada</div>';
              resultsDiv.classList.remove("hidden");
              return;
            }

            contentDiv.innerHTML = data.results.map((p: any) => `
              <a href="/producto/${p.slug}" class="flex items-center gap-3 px-4 py-3 hover:bg-gray-50 transition-colors border-b border-gray-100 last:border-0">
                <img src="${p.images?.[0] || 'https://via.placeholder.com/50'}" class="w-12 h-12 object-cover rounded" />
                <div class="flex-1 min-w-0">
                  <p class="text-sm font-bold text-gray-900 leading-tight">${p.name}</p>
                  <p class="text-sm text-gray-600">${formatPrice(p.price)}</p>
                </div>
              </a>
            `).join("");
            resultsDiv.classList.remove("hidden");
          } catch (err) {
            console.error(err);
          }
        }, 300);
      });
    };

    // Inicializar búsquedas
    const desktopInput = document.getElementById("search-input") as HTMLInputElement;
    const desktopResults = document.getElementById("search-results");
    const desktopContent = document.getElementById("search-results-content");
    if (desktopInput && desktopResults && desktopContent) {
      setupSearch(desktopInput, desktopResults, desktopContent);
    }

    const mobileInput = document.getElementById("search-input-mobile") as HTMLInputElement;
    const mobileResults = document.getElementById("search-results-mobile");
    const mobileContent = document.getElementById("search-results-content-mobile");
    if (mobileInput && mobileResults && mobileContent) {
      setupSearch(mobileInput, mobileResults, mobileContent);
    }
  });
</script>
