---
import "../styles/global.css";
import AdminSidebar from "../components/islands/AdminSidebar";
import { supabase } from "../lib/supabase";
import ToastContainer from "../components/ui/ToastContainer";
import GlobalModal from "../components/functional/GlobalModal";

interface Props {
    title: string;
}

const { title } = Astro.props;
const currentPath = Astro.url.pathname;

// Obtener todas las categorías
const { data: categories } = await supabase
    .from("categories")
    .select("id, name, slug, parent_id")
    .order("name");

// Obtener conteo de consultas pendientes
const { count: pendingCount } = await supabase
    .from("product_inquiries")
    .select("*", { count: "exact", head: true })
    .eq("status", "pending");
---

<!doctype html>
<html lang="es">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width" />
        <link rel="icon" type="image/svg+xml" href="/favicon.svg" />
        <meta name="generator" content={Astro.generator} />
        <link rel="preconnect" href="https://fonts.googleapis.com" />
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
        <link
            href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;600;700&family=Playfair+Display:ital,wght@0,400;0,600;0,700;1,400&display=swap"
            rel="stylesheet"
        />
        <title>{title} | FashionStore Admin</title>
        <style is:global>
            :root {
                --brand-gold: #d4af37;
            }
            .custom-scrollbar::-webkit-scrollbar {
                width: 4px;
            }
            .custom-scrollbar::-webkit-scrollbar-track {
                background: rgba(255, 255, 255, 0.05);
            }
            .custom-scrollbar::-webkit-scrollbar-thumb {
                background: rgba(255, 255, 255, 0.1);
                border-radius: 10px;
            }
            .custom-scrollbar::-webkit-scrollbar-thumb:hover {
                background: rgba(255, 255, 255, 0.2);
            }
            body {
                font-family: "Outfit", sans-serif;
                background-color: #f8fafc;
                background-image:
                    radial-gradient(#e2e8f0 0.5px, transparent 0.5px),
                    radial-gradient(#e2e8f0 0.5px, transparent 0.5px);
                background-size: 30px 30px;
                background-position:
                    0 0,
                    15px 15px;
            }
        </style>
    </head>
    <body class="h-screen flex overflow-hidden">
        <!-- Mobile Sidebar Overlay -->
        <div
            id="sidebar-overlay"
            class="fixed inset-0 bg-slate-900/60 backdrop-blur-sm z-[45] hidden transition-opacity duration-300 opacity-0"
        >
        </div>

        <!-- Sidebar -->
        <aside
            id="admin-sidebar"
            data-collapsed="false"
            data-mobile-open="false"
            class="fixed md:relative inset-y-0 left-0 w-72 bg-[#0F172A] text-white flex flex-col z-50 transition-all duration-300 ease-in-out shadow-2xl md:shadow-none translate-x-[-100%] md:translate-x-0"
        >
            <div
                class="h-20 flex items-center px-8 border-b border-white/5 flex-shrink-0"
            >
                <div class="flex items-center gap-3">
                    <div
                        class="w-8 h-8 bg-brand-gold rounded-lg flex items-center justify-center text-white font-bold shadow-lg shadow-brand-gold/20"
                    >
                        F
                    </div>
                    <span
                        class="sidebar-text text-xl font-bold tracking-tight text-white transition-opacity duration-300"
                        >Fashion<span
                            class="text-brand-gold font-serif italic ml-0.5"
                            >Admin</span
                        ></span
                    >
                </div>
            </div>

            <div class="flex-1 overflow-y-auto custom-scrollbar">
                <AdminSidebar
                    client:load
                    categories={categories || []}
                    pendingCount={pendingCount || 0}
                    currentPath={currentPath}
                    currentCategory={Astro.url.searchParams.get("category")}
                />
            </div>

            <div
                class="p-6 border-t border-white/5 bg-[#1E293B]/30 flex-shrink-0"
            >
                <button
                    id="logout-btn"
                    class="w-full flex items-center justify-center gap-2 px-4 py-2.5 text-sm font-semibold text-white bg-slate-800 border border-slate-700 rounded-xl hover:bg-red-600 hover:border-red-500 transition-all duration-300 group"
                >
                    <svg
                        class="w-4 h-4 text-slate-400 group-hover:text-white transition-colors"
                        fill="none"
                        viewBox="0 0 24 24"
                        stroke="currentColor"
                    >
                        <path
                            stroke-linecap="round"
                            stroke-linejoin="round"
                            stroke-width="2"
                            d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1"
                        ></path>
                    </svg>
                    <span class="sidebar-text transition-opacity duration-300"
                        >Cerrar Sesión</span
                    >
                </button>
            </div>
        </aside>

        <!-- Main Content -->
        <div class="flex-1 flex flex-col overflow-hidden w-full">
            <header
                class="h-20 flex justify-between items-center bg-white/80 backdrop-blur-md border-b border-slate-200 px-4 md:px-8 z-40"
            >
                <div class="flex items-center gap-2 md:gap-4">
                    <button
                        id="sidebar-toggle"
                        class="p-2 hover:bg-slate-100 rounded-lg text-slate-500 transition-colors"
                        title="Alternar menú lateral"
                    >
                        <svg
                            class="w-6 h-6"
                            fill="none"
                            viewBox="0 0 24 24"
                            stroke="currentColor"
                        >
                            <path
                                id="toggle-icon-path"
                                stroke-linecap="round"
                                stroke-linejoin="round"
                                stroke-width="2"
                                d="M4 6h16M4 12h16M4 18h16"></path>
                        </svg>
                    </button>
                    <div>
                        <h1
                            class="text-base md:text-lg font-bold text-slate-800 tracking-tight line-clamp-1"
                        >
                            {title}
                        </h1>
                        <div
                            class="flex items-center gap-1 md:gap-2 text-[10px] text-slate-400"
                        >
                            <span
                                ><span
                                    class="text-slate-500 font-bold tracking-tighter"
                                    >Fashion</span
                                ><span class="text-brand-gold font-serif italic"
                                    >Store</span
                                ></span
                            >
                            <span>/</span>
                            <span class="text-slate-500 font-medium">Panel</span
                            >
                        </div>
                    </div>
                </div>

                <div class="flex items-center gap-2 md:gap-6">
                    <div class="h-8 w-px bg-slate-200"></div>

                    <div class="flex items-center gap-2 md:gap-3">
                        <div class="text-right hidden xs:block">
                            <p
                                class="text-xs md:text-sm font-bold text-slate-800 leading-tight"
                            >
                                Admin
                            </p>
                            <p
                                class="text-[8px] md:text-[10px] uppercase tracking-wider font-bold text-brand-gold"
                            >
                                Super User
                            </p>
                        </div>
                        <div
                            class="h-8 w-8 md:h-10 md:w-10 rounded-lg md:rounded-xl bg-slate-800 flex items-center justify-center text-white text-xs md:text-sm font-bold border-2 border-white shadow-md"
                        >
                            AP
                        </div>
                    </div>
                </div>
            </header>

            <main
                class="flex-1 overflow-y-auto p-4 md:p-8 custom-scrollbar relative"
            >
                <div class="max-w-[1600px] mx-auto">
                    <slot />
                </div>
            </main>
        </div>

        <!-- Notificaciones y Diálogos Globales -->
        <ToastContainer client:load />
        <GlobalModal client:load />

        <script>
            import { supabase } from "../lib/supabase";
            import { clearCart } from "../stores/cartStore";
            import { clearFavorites } from "../stores/favoriteStore";

            function initAdminLayout() {
                const logoutBtn = document.getElementById("logout-btn");
                if (logoutBtn) {
                    logoutBtn.addEventListener("click", async () => {
                        await supabase.auth.signOut();
                        clearCart();
                        clearFavorites();
                        document.cookie =
                            "sb-access-token=; Path=/; Max-Age=0; SameSite=Lax";
                        document.cookie =
                            "sb-refresh-token=; Path=/; Max-Age=0; SameSite=Lax";
                        window.location.href = "/login";
                    });
                }

                const sidebar = document.getElementById("admin-sidebar");
                const toggleBtn = document.getElementById("sidebar-toggle");
                const overlay = document.getElementById("sidebar-overlay");
                const toggleIconPath =
                    document.getElementById("toggle-icon-path");

                if (!sidebar || !toggleBtn || !overlay) return;

                const isMobile = () => window.innerWidth < 768;

                function applyCollapsedState(collapsed: boolean) {
                    if (!sidebar || isMobile()) return;

                    sidebar.setAttribute(
                        "data-collapsed",
                        collapsed.toString(),
                    );
                    if (collapsed) {
                        sidebar.style.width = "80px";
                    } else {
                        sidebar.style.width = "288px";
                    }

                    window.dispatchEvent(
                        new CustomEvent("sidebar-toggle", {
                            detail: { collapsed },
                        }),
                    );
                }

                function toggleMobileSidebar(open: boolean) {
                    if (!sidebar || !overlay || !toggleIconPath) return;

                    if (open) {
                        sidebar.classList.remove("translate-x-[-100%]");
                        sidebar.classList.add("translate-x-0");
                        overlay.classList.remove("hidden");
                        setTimeout(
                            () => overlay.classList.add("opacity-100"),
                            10,
                        );
                        toggleIconPath.setAttribute(
                            "d",
                            "M6 18L18 6M6 6l12 12",
                        );
                    } else {
                        sidebar.classList.remove("translate-x-0");
                        sidebar.classList.add("translate-x-[-100%]");
                        overlay.classList.remove("opacity-100");
                        setTimeout(() => overlay.classList.add("hidden"), 300);
                        toggleIconPath.setAttribute(
                            "d",
                            "M4 6h16M4 12h16M4 18h16",
                        );
                    }
                    sidebar.setAttribute("data-mobile-open", open.toString());
                }

                // Initial state for desktop
                if (!isMobile()) {
                    const savedState =
                        localStorage.getItem("admin-sidebar-collapsed") ===
                        "true";
                    applyCollapsedState(savedState);
                }

                toggleBtn.addEventListener("click", () => {
                    if (isMobile()) {
                        const isOpen =
                            sidebar.getAttribute("data-mobile-open") === "true";
                        toggleMobileSidebar(!isOpen);
                    } else {
                        const isCurrentlyCollapsed =
                            sidebar.getAttribute("data-collapsed") === "true";
                        const newState = !isCurrentlyCollapsed;
                        applyCollapsedState(newState);
                        localStorage.setItem(
                            "admin-sidebar-collapsed",
                            newState.toString(),
                        );
                    }
                });

                overlay.addEventListener("click", () => {
                    toggleMobileSidebar(false);
                });

                // Cierre sesión automático si no hay token (opcional)
                // Escuchar cambios de tamaño de ventana
                window.addEventListener("resize", () => {
                    if (!isMobile()) {
                        overlay.classList.add("hidden");
                        sidebar.classList.remove("translate-x-[-100%]");
                        sidebar.classList.add("translate-x-0");
                        const savedState =
                            localStorage.getItem("admin-sidebar-collapsed") ===
                            "true";
                        applyCollapsedState(savedState);
                    } else {
                        sidebar.classList.add("translate-x-[-100%]");
                        sidebar.style.width = "288px";
                    }
                });
            }

            document.addEventListener("DOMContentLoaded", initAdminLayout);
            document.addEventListener("astro:after-swap", initAdminLayout);
        </script>

        <style is:global>
            #admin-sidebar[data-collapsed="true"]:not(.mobile-open)
                .sidebar-text {
                display: none;
            }
            #admin-sidebar[data-collapsed="true"]:not(.mobile-open) .h-20 {
                padding-left: 0;
                padding-right: 0;
                justify-content: center;
            }
            @media (max-width: 767px) {
                #admin-sidebar {
                    width: 288px !important;
                }
                .sidebar-text {
                    display: block !important;
                    opacity: 1 !important;
                }
            }
        </style>
    </body>
</html>
